<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¼ì¥í„° ì •ë³´í™” ê¸°ê¸° ê°€ê²© ì¶”ì ê¸° </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 98%; margin: 0 auto; padding: 20px; }
        
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 13px; }
        select, input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        .table-wrapper { 
            overflow-x: auto; 
            max-height: 700px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            border-radius: 8px; 
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        table { border-collapse: separate; border-spacing: 0; background: white; font-size: 12px; white-space: nowrap; }
        th, td { border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; padding: 8px 10px; vertical-align: middle; }
        
        thead th { position: sticky; top: 0; z-index: 30; background-color: #f3f4f6; border-top: 1px solid #e5e7eb; height: 40px; }
        
        /* ê³ ì • ì»¬ëŸ¼ */
        th:nth-child(1), td:nth-child(1) { position: sticky; left: 0; z-index: 20; background-color: #f9fafb; border-right: 2px solid #e5e7eb; text-align: center;}
        th:nth-child(2), td:nth-child(2) { position: sticky; left: 50px; z-index: 20; background-color: #f9fafb; border-right: 2px solid #e5e7eb; }
        th:nth-child(3), td:nth-child(3) { position: sticky; left: 180px; z-index: 20; background-color: #f9fafb; border-right: 2px solid #dedede; }
        
        thead th:nth-child(1), thead th:nth-child(2), thead th:nth-child(3) { z-index: 40; background-color: #e5e7eb; }

        .btn { padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; border: none; font-size: 13px; transition: 0.2s; }
        .btn-blue { background-color: #2563eb; }
        .btn-green { background-color: #16a34a; }
        .btn-red { background-color: #ef4444; }
        .btn-indigo { background-color: #4f46e5; }
        .btn-gray { background-color: #6b7280; }
        .btn:hover { opacity: 0.9; }

        .bg-red-row { background-color: #fef2f2 !important; }
        .bg-green-row { background-color: #f0fdf4 !important; }
        .sorted-header { background-color: #dbeafe !important; color: #1e40af; border-bottom: 2px solid #2563eb; }

        .filter-box { background-color: #eff6ff; border: 1px solid #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;}

        /* ê·œê²© ìŠ¤íƒ€ì¼ */
        .spec-cell-compact {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .spec-cell-full {
            max-width: none;
            white-space: normal;
            min-width: 400px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“Š ì¡°ë‹¬ì²­ ë°ì´í„° í†µí•© ê´€ë¦¬ê¸°</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h3 class="font-bold text-gray-700 mb-2">ğŸ“‚ 1. ì´ì „ íˆìŠ¤í† ë¦¬ íŒŒì¼ (CSV)</h3>
            <input type="file" id="prevFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
            <div id="fileStatus" class="mt-2 text-xs text-blue-600 font-bold h-4"></div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h3 class="font-bold text-gray-700 mb-2">ğŸ“ 2. ì˜¤ëŠ˜ ë°ì´í„° ì…ë ¥</h3>
            <div class="flex gap-2 mb-2">
                <select id="categorySelect" class="flex-1">
                    <option value="ë…¸íŠ¸ë¶">ë…¸íŠ¸ë¶</option>
                    <option value="ë°ìŠ¤í¬í†±ì»´í“¨í„°">ë°ìŠ¤í¬í†±ì»´í“¨í„°</option>
                    <option value="ëª¨ë‹ˆí„°">ëª¨ë‹ˆí„°</option>
                    <option value="ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ">ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <input type="date" id="todayDate" class="flex-1" onchange="renderTable()">
            </div>
            <textarea id="rawData" placeholder="í˜ì´ì§€ ì „ì²´(Ctrl+A)ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
            <div class="flex gap-2 mt-2">
                <button onclick="processData()" class="w-full btn btn-blue">ë°ì´í„° ë¶„ì„ ë° ë³‘í•©</button>
                <button onclick="resetData()" class="w-1/4 btn btn-red">ğŸ”„ ë¦¬ì…‹</button>
            </div>
        </div>
    </div>

    <div id="resultArea" class="bg-white p-4 rounded-lg shadow hidden">
        <div class="flex flex-wrap justify-between items-end mb-2">
            <h2 class="text-xl font-bold text-gray-800">ë¶„ì„ ê²°ê³¼ (<span id="count">0</span>ê±´)</h2>
            <button onclick="downloadCSV()" class="btn btn-green">ğŸ’¾ ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div class="filter-box">
            <div>
                <label class="font-bold text-gray-700 mr-2">ğŸ¢ ì—…ì²´ëª…:</label>
                <select id="companyFilter" onchange="renderTable()" style="width: 150px;">
                    <option value="">ì „ì²´ ì—…ì²´</option>
                </select>
            </div>
            <div>
                <label class="font-bold text-gray-700 mr-2">ğŸ“ˆ ìƒíƒœ:</label>
                <select id="statusFilter" onchange="renderTable()" style="width: 120px;">
                    <option value="">ì „ì²´ ë³´ê¸°</option>
                    <option value="UP">ì¸ìƒ (ğŸ”º)</option>
                    <option value="DOWN">ì¸í•˜ (ğŸ”»)</option>
                    <option value="NEW">ì‹ ê·œ (ğŸ†•)</option>
                    <option value="SAME">ë³€ë™ì—†ìŒ</option>
                </select>
            </div>
            
            <button onclick="toggleSpecView()" class="btn btn-indigo" id="specToggleBtn">â†” ê·œê²© ì „ì²´ë³´ê¸°</button>
            
            <div class="text-xs text-blue-800 ml-auto font-bold bg-blue-100 px-3 py-1 rounded border border-blue-200">
                ì •ë ¬: <span id="sortLabel">ì˜¤ëŠ˜ ë‚ ì§œ</span> ê°€ê²© ë‚®ì€ìˆœ â–²
            </div>
        </div>

        <div class="table-wrapper">
            <table id="resultTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.getElementById('todayDate').valueAsDate = new Date();

    let mergedData = [];       
    let dateColumns = [];      
    const fixedCols = ['ìƒíƒœ', 'ì—…ì²´ëª…', 'ì‹ë³„ë²ˆí˜¸', 'ì¸ë„ì¡°ê±´', 'ê·œê²©', 'ê³„ì•½ì¢…ë£Œì¼', 'ë³€ë™ì•¡', 'ë¹„ê³ '];
    let isSpecExpanded = false;

    document.getElementById('prevFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if(results.data.length === 0) return;
                const headers = results.meta.fields;
                dateColumns = headers.filter(h => !fixedCols.includes(h)).sort();
                
                let tempMap = new Map();
                results.data.forEach(row => {
                    if(row['ì‹ë³„ë²ˆí˜¸']) tempMap.set(row['ì‹ë³„ë²ˆí˜¸'], row);
                });
                
                mergedData = Array.from(tempMap.values());
                document.getElementById('fileStatus').innerText = `âœ… ê¸°ì¡´ ë°ì´í„° ${mergedData.length}ê±´ ë¡œë“œë¨`;
                updateFilters();
                renderTable();
            }
        });
    });

    function processData() {
        const rawText = document.getElementById('rawData').value;
        const todayStr = document.getElementById('todayDate').value;
        
        if (!dateColumns.includes(todayStr) && rawText.trim()) {
            dateColumns.push(todayStr);
            dateColumns.sort();
        }

        const todayMap = new Map();
        
        if (rawText.trim()) {
            const lines = rawText.split('\n').map(l => l.trim());
            let idIndices = [];
            lines.forEach((line, index) => {
                // ì‹ë³„ë²ˆí˜¸ í‚¤ì›Œë“œ ìœ„ì¹˜ ì°¾ê¸°
                if (line === "ì‹ë³„ë²ˆí˜¸" || line.startsWith("ì‹ë³„ë²ˆí˜¸")) {
                    idIndices.push(index);
                }
            });

            for (let i = 0; i < idIndices.length; i++) {
                const currentIndex = idIndices[i];
                const nextIndex = (i + 1 < idIndices.length) ? idIndices[i+1] : lines.length;
                
                // ì‹ë³„ë²ˆí˜¸ ì£¼ë³€ 15ì¤„ ìœ„ ~ ë‹¤ìŒ ì‹ë³„ë²ˆí˜¸ ì „ê¹Œì§€ë¥¼ í•˜ë‚˜ì˜ ë©ì–´ë¦¬ë¡œ ì¸ì‹
                const startIndex = Math.max(0, currentIndex - 15); 
                const endIndex = nextIndex;

                const chunkLines = lines.slice(startIndex, endIndex);
                const item = parseChunk(chunkLines);
                
                // IDì™€ ê°€ê²©ì´ ëª¨ë‘ ìœ íš¨í•œ ê²½ìš°ë§Œ ì €ì¥
                if (item.id && item.price > 0) {
                    // [í•µì‹¬] ì¤‘ë³µ ë°œìƒ ì‹œ 'ê°€ê²©ì´ ë†’ì€ ê²ƒ'ìœ¼ë¡œ ë®ì–´ì“°ê¸°
                    updateMapWithHighPrice(todayMap, item.id, item);
                }
            }
        }

        // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©
        let finalMap = new Map();
        mergedData.forEach(row => { 
            if(row['ì‹ë³„ë²ˆí˜¸']) finalMap.set(row['ì‹ë³„ë²ˆí˜¸'], row);
        });

        todayMap.forEach((item, id) => {
            if (finalMap.has(id)) {
                let row = finalMap.get(id);
                // ê°€ê²© ë° ë‚ ì§œ ì—…ë°ì´íŠ¸
                row[todayStr] = item.price;
                row['ê³„ì•½ì¢…ë£Œì¼'] = item.endDate;
                
                // [ì¤‘ìš”] ì˜¤ëŠ˜ ë“¤ì–´ì˜¨ ë°ì´í„°ê°€ 'ê°€ê²©ì´ ë†’ì€' ë°ì´í„°ì´ë¯€ë¡œ
                // ì¸ë„ì¡°ê±´ê³¼ ê·œê²© ì •ë³´ë¥¼ ìµœì‹ í™”í•©ë‹ˆë‹¤.
                // (ì´ì „ ë¡œì§ì—ì„œëŠ” í˜„ì¥ì„¤ì¹˜ë„ì¼ë•Œë§Œ ë°”ê¿¨ìœ¼ë‚˜, ì´ì œëŠ” ì˜¤ëŠ˜ ì„ íƒëœê²Œ ì™•ì…ë‹ˆë‹¤)
                row['ì¸ë„ì¡°ê±´'] = item.delivery;
                row['ê·œê²©'] = item.spec;
                if(item.company) row['ì—…ì²´ëª…'] = item.company;

            } else {
                let newRow = {
                    'ì—…ì²´ëª…': item.company,
                    'ì‹ë³„ë²ˆí˜¸': item.id,
                    'ì¸ë„ì¡°ê±´': item.delivery,
                    'ê·œê²©': item.spec,
                    'ê³„ì•½ì¢…ë£Œì¼': item.endDate,
                    [todayStr]: item.price
                };
                finalMap.set(id, newRow);
            }
        });

        mergedData = Array.from(finalMap.values());
        calculateStatus(todayStr);
        updateFilters();
        renderTable();
    }

    // [í—¬í¼] ì¤‘ë³µ ë°ì´í„° ì²˜ë¦¬ ë¡œì§ (ë†’ì€ ê°€ê²© ìŠ¹ë¦¬)
    function updateMapWithHighPrice(map, id, newItem) {
        if (map.has(id)) {
            const existingItem = map.get(id);
            const oldPrice = existingItem.price;
            const newPrice = newItem.price;

            // 1. ê°€ê²©ì´ ë” ë¹„ì‹¸ë©´ ë¬´ì¡°ê±´ êµì²´
            if (newPrice > oldPrice) {
                map.set(id, newItem);
            } 
            // 2. ê°€ê²©ì´ ê°™ìœ¼ë©´? 'í˜„ì¥ì„¤ì¹˜ë„'ë¥¼ ê°€ì§„ ë†ˆì´ ì´ê¹€
            else if (newPrice === oldPrice) {
                const newDel = newItem.delivery || "";
                const oldDel = existingItem.delivery || "";
                if (!oldDel.includes("í˜„ì¥ì„¤ì¹˜") && newDel.includes("í˜„ì¥ì„¤ì¹˜")) {
                    map.set(id, newItem);
                }
            }
            // ê°€ê²©ì´ ë” ì‹¸ë©´? ë¬´ì‹œí•¨ (ê¸°ì¡´ ë†’ì€ ê°€ê²© ë°ì´í„° ìœ ì§€)
        } else {
            // ì²˜ìŒ ë“¤ì–´ì˜¤ëŠ” IDë©´ ê·¸ëƒ¥ ì €ì¥
            map.set(id, newItem);
        }
    }

    function parseChunk(lines) {
        let item = { company: '', id: '', spec: '', price: 0, endDate: '', delivery: '' };
        
        // 1. ì‹ë³„ë²ˆí˜¸ ì°¾ê¸°
        const idLabelIdx = lines.findIndex(l => l.includes("ì‹ë³„ë²ˆí˜¸"));
        if(idLabelIdx !== -1) {
            if (lines[idLabelIdx + 1] && /^\d{8,}$/.test(lines[idLabelIdx + 1])) {
                item.id = lines[idLabelIdx + 1];
            } else {
                const match = lines[idLabelIdx].match(/\d{8,}/);
                if(match) item.id = match[0];
            }
        }
        if(!item.id) return item;

        // 2. ì—…ì²´ëª… ì°¾ê¸°
        for(let i=0; i < lines.length; i++) {
            if (/^[ê°€-í£a-zA-Z]+\(\d{8,}\)$/.test(lines[i]) && lines[i+1]) {
                item.company = lines[i+1];
                break; 
            }
            if ((lines[i].includes("ì£¼ì‹íšŒì‚¬") || lines[i].includes("(ì£¼)")) && lines[i].length < 20) {
                 item.company = lines[i]; 
            }
        }

        // 3. ì¸ë„ì¡°ê±´ ì°¾ê¸°
        const delLabelIdx = lines.findIndex(l => l.includes("ì¸ë„ì¡°ê±´"));
        if(delLabelIdx !== -1 && lines[delLabelIdx + 1]) {
            item.delivery = lines[delLabelIdx + 1];
        } else {
            const delKeyword = lines.find(l => l.includes("í˜„ì¥ì„¤ì¹˜ë„") || l.includes("ë‚©í’ˆì¥ì†Œë„"));
            if (delKeyword) item.delivery = delKeyword;
        }

        // 4. ê·œê²© ì°¾ê¸°
        const categoryVal = document.getElementById('categorySelect').value;
        const specLine = lines.find(l => 
            (l.startsWith(categoryVal) && l.includes(",")) || 
            (l.includes(",") && l.length > 25 && !l.includes("ê°€ê²©ë²”ìœ„") && !l.includes("ë°”ë¡œê°€ê¸°") && !l.includes("ì¸ë„ì¡°ê±´"))
        );
        item.spec = specLine || '';

        // 5. ê°€ê²© ì°¾ê¸° (ì •ê·œì‹ ì™„í™”)
        // "ìˆ«ì,ìˆ«ìì›" íŒ¨í„´ì„ ì°¾ë˜, ì•ë’¤ì— ë‹¤ë¥¸ ê¸€ìê°€ ìˆì–´ë„ ìˆ«ìë§Œ ì¶”ì¶œ
        const priceLine = lines.find(l => /[0-9,]+ì›/.test(l) && !l.includes("ìµœì €") && !l.includes("ìµœê³ "));
        if (priceLine) {
            // "545,000ì›" ë¶€ë¶„ë§Œ ì¶”ì¶œí•´ì„œ ìˆ«ìë¡œ ë³€í™˜
            const match = priceLine.match(/([0-9,]+)ì›/);
            if (match) {
                item.price = parseInt(match[1].replace(/,/g, ''));
            }
        }

        // 6. ì¢…ë£Œì¼ ì°¾ê¸°
        const dateLine = lines.find(l => /20\d{2}\.\d{2}\.\d{2}/.test(l) && !l.includes("ë‚©í’ˆê¸°í•œ"));
        if(dateLine) item.endDate = dateLine;

        return item;
    }

    function calculateStatus(currentDate) {
        const curIdx = dateColumns.indexOf(currentDate);
        const prevDate = curIdx > 0 ? dateColumns[curIdx - 1] : null;

        mergedData.forEach(row => {
            const curP = parseInt(row[currentDate]) || 0;
            if (curP === 0) {
                row['ìƒíƒœ'] = 'SAME'; row['ë³€ë™ì•¡'] = 0; return; 
            }
            const prevP = prevDate ? (parseInt(row[prevDate]) || 0) : 0;
            if (prevP === 0) {
                row['ìƒíƒœ'] = 'NEW'; row['ë³€ë™ì•¡'] = 0;
            } else {
                const diff = curP - prevP;
                row['ë³€ë™ì•¡'] = diff;
                if (diff > 0) row['ìƒíƒœ'] = 'UP';
                else if (diff < 0) row['ìƒíƒœ'] = 'DOWN';
                else row['ìƒíƒœ'] = 'SAME';
            }
        });
    }

    function toggleSpecView() {
        isSpecExpanded = !isSpecExpanded;
        const btn = document.getElementById('specToggleBtn');
        if(isSpecExpanded) {
            btn.innerText = ">< ê·œê²© ì¢ê²Œë³´ê¸°";
            btn.classList.replace('btn-indigo', 'btn-gray');
        } else {
            btn.innerText = "â†” ê·œê²© ì „ì²´ë³´ê¸°";
            btn.classList.replace('btn-gray', 'btn-indigo');
        }
        renderTable();
    }

    function resetData() {
        if(!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        mergedData = [];
        dateColumns = [];
        document.getElementById('rawData').value = "";
        document.getElementById('prevFile').value = "";
        document.getElementById('fileStatus').innerText = "";
        document.getElementById('resultArea').classList.add('hidden');
        document.getElementById('companyFilter').innerHTML = '<option value="">ì „ì²´ ì—…ì²´</option>';
    }

    function updateFilters() {
        const companySet = new Set();
        mergedData.forEach(row => { if(row['ì—…ì²´ëª…']) companySet.add(row['ì—…ì²´ëª…']); });
        const sortedComp = Array.from(companySet).sort();
        const sel = document.getElementById("companyFilter");
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">ì „ì²´ ì—…ì²´</option>';
        sortedComp.forEach(c => {
            const op = document.createElement("option");
            op.value = c; op.innerText = c;
            sel.appendChild(op);
        });
        sel.value = currentVal; 
    }

    function renderTable() {
        const compVal = document.getElementById("companyFilter").value;
        const statVal = document.getElementById("statusFilter").value;
        const todayKey = document.getElementById("todayDate").value;

        document.getElementById("sortLabel").innerText = todayKey;

        const filtered = mergedData.filter(row => {
            const matchComp = (compVal === "") || (row['ì—…ì²´ëª…'] === compVal);
            const matchStat = (statVal === "") || (row['ìƒíƒœ'] === statVal);
            return matchComp && matchStat;
        });

        filtered.sort((a, b) => {
            const valA = a[todayKey];
            const valB = b[todayKey];
            const priceA = valA ? parseInt(String(valA).replace(/,/g, '')) : 0;
            const priceB = valB ? parseInt(String(valB).replace(/,/g, '')) : 0;
            if (priceA !== priceB) return priceA - priceB; 
            return (a['ì—…ì²´ëª…']||"").localeCompare(b['ì—…ì²´ëª…']||"");
        });

        const thead = document.querySelector("#resultTable thead");
        let thHTML = `<tr>
            <th style="width:50px;">ìƒíƒœ</th>
            <th style="width:130px;">ì—…ì²´ëª…</th>
            <th style="width:80px;">ì‹ë³„ë²ˆí˜¸</th>
            <th style="width:100px;">ì¸ë„ì¡°ê±´</th>
            <th style="min-width:200px;">ê·œê²©</th>`;
        
        dateColumns.forEach(date => {
            const isSortKey = (date === todayKey);
            const classAttr = isSortKey ? 'class="sorted-header"' : '';
            const icon = isSortKey ? ' â–²' : '';
            thHTML += `<th ${classAttr} style="width:90px; text-align:right;">${date}${icon}</th>`;
        });

        thHTML += `<th style="width:80px; text-align:right;">ë³€ë™ì•¡</th><th style="width:90px;">ì¢…ë£Œì¼</th></tr>`;
        thead.innerHTML = thHTML;

        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";

        const specClass = isSpecExpanded ? 'spec-cell-full' : 'spec-cell-compact';

        filtered.forEach(row => {
            const tr = document.createElement("tr");
            let statusBadge = `<span class="text-gray-400">-</span>`;
            if(row['ìƒíƒœ'] === 'UP') { statusBadge = `ğŸ”º`; tr.classList.add("bg-red-row"); }
            else if(row['ìƒíƒœ'] === 'DOWN') { statusBadge = `ğŸ”»`; tr.classList.add("bg-green-row"); }
            else if(row['ìƒíƒœ'] === 'NEW') { statusBadge = `<span class="text-blue-600 font-bold">N</span>`; }

            let html = `
                <td style="text-align:center;">${statusBadge}</td>
                <td style="font-weight:bold; color:#374151;">${row['ì—…ì²´ëª…']||''}</td>
                <td>${row['ì‹ë³„ë²ˆí˜¸']}</td>
                <td style="color:#666; font-size:11px;">${row['ì¸ë„ì¡°ê±´']||''}</td>
                <td class="${specClass}" title="${row['ê·œê²©']}" style="font-size:11px; color:#555;">${row['ê·œê²©']||''}</td>
            `;

            dateColumns.forEach(date => {
                const val = row[date];
                const displayVal = val ? parseInt(String(val).replace(/,/g,'')).toLocaleString() : '-';
                const isToday = (date === todayKey);
                let colorStyle = "";
                if (isToday) {
                    if (row['ìƒíƒœ'] === 'UP') colorStyle = "color:#dc2626; font-weight:bold;";
                    else if (row['ìƒíƒœ'] === 'DOWN') colorStyle = "color:#16a34a; font-weight:bold;";
                    else if (row['ìƒíƒœ'] === 'NEW') colorStyle = "color:#2563eb; font-weight:bold;";
                }
                html += `<td style="text-align:right; ${colorStyle}">${displayVal}</td>`;
            });

            const diff = row['ë³€ë™ì•¡'];
            let diffStr = (diff > 0) ? `+${parseInt(diff).toLocaleString()}` : (diff ? parseInt(diff).toLocaleString() : '-');
            let diffColor = (diff > 0) ? 'color:#dc2626;' : (diff < 0 ? 'color:#16a34a;' : 'color:#999;');

            html += `<td style="text-align:right; font-weight:bold; ${diffColor}">${diffStr}</td><td style="font-size:11px;">${row['ê³„ì•½ì¢…ë£Œì¼']||''}</td>`;
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        document.getElementById("resultArea").classList.remove("hidden");
        document.getElementById("count").innerText = filtered.length;
    }

    function downloadCSV() {
        if (mergedData.length === 0) return;
        const category = document.getElementById('categorySelect').value;
        const today = new Date().toISOString().slice(0,10).replace(/-/g,"");
        const finalCsvData = mergedData.map(row => {
            let item = { 'ìƒíƒœ': row['ìƒíƒœ'], 'ì—…ì²´ëª…': row['ì—…ì²´ëª…'], 'ì‹ë³„ë²ˆí˜¸': row['ì‹ë³„ë²ˆí˜¸'], 'ì¸ë„ì¡°ê±´': row['ì¸ë„ì¡°ê±´'], 'ê·œê²©': row['ê·œê²©'] };
            dateColumns.forEach(d => item[d] = row[d]);
            item['ë³€ë™ì•¡'] = row['ë³€ë™ì•¡'];
            item['ê³„ì•½ì¢…ë£Œì¼'] = row['ê³„ì•½ì¢…ë£Œì¼'];
            return item;
        });
        const csv = Papa.unparse(finalCsvData, { quotes: true });
        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ì¡°ë‹¬ì²­_${category}_ê°€ê²©ëŒ€ì¥_${today}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
