<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¼ì¥í„° ì •ë³´í™”ì¥ë¹„ ê°€ê²© ì¶”ì ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 13px;
        }

        select,
        input[type="date"] {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 700px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            font-size: 12px;
            white-space: nowrap;
        }

        th,
        td {
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            padding: 8px 10px;
            vertical-align: middle;
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 30;
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            height: 40px;
        }

        th:nth-child(1),
        td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: #f9fafb;
            border-right: 2px solid #e5e7eb;
            text-align: center;
        }

        th:nth-child(2),
        td:nth-child(2) {
            position: sticky;
            left: 50px;
            z-index: 20;
            background-color: #f9fafb;
            border-right: 2px solid #e5e7eb;
        }

        th:nth-child(3),
        td:nth-child(3) {
            position: sticky;
            left: 180px;
            z-index: 20;
            background-color: #f9fafb;
            border-right: 2px solid #dedede;
        }

        thead th:nth-child(1),
        thead th:nth-child(2),
        thead th:nth-child(3) {
            z-index: 40;
            background-color: #e5e7eb;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            border: none;
            font-size: 13px;
            transition: 0.2s;
        }

        .btn-blue {
            background-color: #2563eb;
        }

        .btn-green {
            background-color: #16a34a;
        }

        .btn-red {
            background-color: #ef4444;
        }

        .btn-indigo {
            background-color: #4f46e5;
        }

        .btn-gray {
            background-color: #6b7280;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .bg-red-row {
            background-color: #fef2f2 !important;
        }

        .bg-green-row {
            background-color: #f0fdf4 !important;
        }

        .sorted-header {
            background-color: #dbeafe !important;
            color: #1e40af;
            border-bottom: 2px solid #2563eb;
        }

        .filter-box {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .spec-cell-compact {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .spec-cell-full {
            max-width: none;
            white-space: normal;
            min-width: 400px;
        }

        /* ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #detailModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 85%;
            overflow: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .modal-body table {
            font-size: 13px;
        }

        .modal-body th {
            background-color: #f9fafb;
            color: #4b5563;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .close-btn {
            cursor: pointer;
            font-size: 24px;
            color: #9ca3af;
            transition: 0.2s;
        }

        .close-btn:hover {
            color: #4b5563;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">ë‚˜ë¼ì¥í„° ì •ë³´í™”ì¥ë¹„ ê°€ê²© ì¶”ì ê¸°</h1>
            <a href="viewer.html" class="btn btn-indigo text-white no-underline">ë·°ì–´ í˜ì´ì§€ ì´ë™</a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <h3 class="font-bold text-gray-700 mb-2">1. ì´ì „ íˆìŠ¤í† ë¦¬ íŒŒì¼ (CSV)</h3>
                <input type="file" id="prevFile" accept=".csv"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                <div id="fileStatus" class="mt-2 text-xs text-blue-600 font-bold h-4"></div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                <h3 class="font-bold text-gray-700 mb-2">2. ì˜¤ëŠ˜ ë°ì´í„° ì…ë ¥</h3>
                <div class="flex gap-2 mb-2">
                    <select id="categorySelect" class="flex-1">
                        <option value="ë…¸íŠ¸ë¶">ë…¸íŠ¸ë¶</option>
                        <option value="ë°ìŠ¤í¬í†±ì»´í“¨í„°">ë°ìŠ¤í¬í†±ì»´í“¨í„°</option>
                        <option value="ëª¨ë‹ˆí„°">ëª¨ë‹ˆí„°</option>
                        <option value="ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ">ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                    <input type="date" id="todayDate" class="flex-1" onchange="renderTable()">
                </div>
                <textarea id="rawData" placeholder="í˜ì´ì§€ ì „ì²´(Ctrl+A)ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="processData()" class="w-full btn btn-blue">ë°ì´í„° ë¶„ì„ ë° ë³‘í•©</button>
                    <button onclick="resetData()" class="w-1/4 btn btn-red">ë¦¬ì…‹</button>
                </div>
            </div>
        </div>

        <div id="resultArea" class="bg-white p-4 rounded-lg shadow hidden">
            <div class="flex flex-wrap justify-between items-end mb-2">
                <h2 class="text-xl font-bold text-gray-800">ë¶„ì„ ê²°ê³¼ (<span id="count">0</span>ê±´)</h2>
                <button onclick="downloadCSV()" class="btn btn-green">ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div class="filter-box">
                <div>
                    <label class="font-bold text-gray-700 mr-2">ì—…ì²´ëª…:</label>
                    <select id="companyFilter" onchange="renderTable()" style="width: 150px;">
                        <option value="">ì „ì²´ ì—…ì²´</option>
                    </select>
                </div>
                <div>
                    <label class="font-bold text-gray-700 mr-2">ìƒíƒœ:</label>
                    <select id="statusFilter" onchange="renderTable()" style="width: 120px;">
                        <option value="">ì „ì²´ ë³´ê¸°</option>
                        <option value="UP">ì¸ìƒ (ğŸ”º)</option>
                        <option value="DOWN">ì¸í•˜ (ğŸ”»)</option>
                        <option value="NEW">ì‹ ê·œ</option>
                        <option value="SAME">ë³€ë™ì—†ìŒ</option>
                    </select>
                </div>

                <button onclick="toggleSpecView()" class="btn btn-indigo" id="specToggleBtn">â†” ê·œê²© ì „ì²´ë³´ê¸°</button>

                <div
                    class="text-xs text-blue-800 ml-auto font-bold bg-blue-100 px-3 py-1 rounded border border-blue-200">
                    ì •ë ¬: <span id="sortLabel">ì˜¤ëŠ˜ ë‚ ì§œ</span> ê°€ê²© ë‚®ì€ìˆœ â–²
                </div>
            </div>

            <div class="table-wrapper">
                <table id="resultTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-800">ìƒì„¸ ê·œê²© ì •ë³´</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" class="modal-body">
                <div class="flex items-center justify-center p-10">
                    <div class="loading-spinner"></div>
                    <span class="ml-3 text-gray-600">ë°ì´í„°ë¥¼ ì°¾ëŠ” ì¤‘...</span>
                </div>
            </div>
            <div id="modalFooter" class="mt-4 pt-4 border-t border-gray-100 hidden">
                <p class="text-xs text-gray-500 mb-2">â€» ìë™ ë¡œë“œ ì‹¤íŒ¨ ì‹œ: ì—‘ì…€ íŒŒì¼(desktop_db.xlsx)ì„ ì§ì ‘ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                <input type="file" id="excelDbFile" accept=".xlsx" class="text-xs text-gray-600">
            </div>
        </div>
    </div>

    <script>
        document.getElementById('todayDate').valueAsDate = new Date();

        let mergedData = [];
        let dateColumns = [];
        const fixedCols = ['ìƒíƒœ', 'ì—…ì²´ëª…', 'ì‹ë³„ë²ˆí˜¸', 'ê·œê²©', 'ê³„ì•½ì¢…ë£Œì¼', 'ë³€ë™ì•¡', 'ë¹„ê³ '];
        let isSpecExpanded = false;

        document.getElementById('prevFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    if (results.data.length === 0) return;
                    const headers = results.meta.fields;
                    dateColumns = headers.filter(h => !fixedCols.includes(h)).sort();

                    let tempMap = new Map();
                    results.data.forEach(row => {
                        if (row['ì‹ë³„ë²ˆí˜¸']) tempMap.set(row['ì‹ë³„ë²ˆí˜¸'], row);
                    });

                    mergedData = Array.from(tempMap.values());
                    document.getElementById('fileStatus').innerText = `ê¸°ì¡´ ë°ì´í„° ${mergedData.length}ê±´ ë¡œë“œë¨`;
                    updateFilters();
                    renderTable();
                }
            });
        });

        function processData() {
            const rawText = document.getElementById('rawData').value;
            const todayStr = document.getElementById('todayDate').value;

            if (!dateColumns.includes(todayStr) && rawText.trim()) {
                dateColumns.push(todayStr);
                dateColumns.sort();
            }

            const todayMap = new Map();

            if (rawText.trim()) {
                const lines = rawText.split('\n').map(l => l.trim());
                let idIndices = [];
                lines.forEach((line, index) => {
                    if (line === "ì‹ë³„ë²ˆí˜¸" || line.startsWith("ì‹ë³„ë²ˆí˜¸")) {
                        idIndices.push(index);
                    }
                });

                // 1. ëª¨ë“  í›„ë³´ ë°ì´í„°ë¥¼ ì¼ë‹¨ ìˆ˜ì§‘ (ì¤‘ë³µ í¬í•¨)
                let candidates = [];
                for (let i = 0; i < idIndices.length; i++) {
                    const currentIndex = idIndices[i];
                    const nextIndex = (i + 1 < idIndices.length) ? idIndices[i + 1] : lines.length;

                    // ê²€ìƒ‰ ë²”ìœ„: ì‹ë³„ë²ˆí˜¸ ê¸°ì¤€ -15ì¤„ ~ ë‹¤ìŒ ì‹ë³„ë²ˆí˜¸ ì§ì „
                    const startIndex = Math.max(0, currentIndex - 15);
                    const endIndex = nextIndex;

                    const chunkLines = lines.slice(startIndex, endIndex);

                    // [ì¤‘ìš”] ì‹ë³„ë²ˆí˜¸ê°€ ìˆëŠ” ì¤„ì˜ 'ìƒëŒ€ì  ìœ„ì¹˜'ë¥¼ ì°¾ì•„ì„œ íŒŒì‹±ì— ì „ë‹¬
                    // ì´ë ‡ê²Œ í•´ì•¼ ë©ì–´ë¦¬ ì•ˆì—ì„œ 'ì‹ë³„ë²ˆí˜¸ ì•„ë˜'ì— ìˆëŠ” ê°€ê²©ì„ ì •í™•íˆ ì°¾ìŒ
                    const relativeIdIndex = currentIndex - startIndex;
                    const item = parseChunk(chunkLines, relativeIdIndex);

                    if (item.id && item.price > 0) {
                        candidates.push(item);
                    }
                }

                // 2. ìˆ˜ì§‘ëœ í›„ë³´ë“¤ ì¤‘ 'ì‹ë³„ë²ˆí˜¸'ë³„ë¡œ 'ìµœê³ ê°€' ë°ì´í„°ë§Œ ì„ ë³„
                candidates.forEach(item => {
                    updateMapWithHighPrice(todayMap, item.id, item);
                });
            }

            let finalMap = new Map();
            mergedData.forEach(row => {
                if (row['ì‹ë³„ë²ˆí˜¸']) finalMap.set(row['ì‹ë³„ë²ˆí˜¸'], row);
            });

            todayMap.forEach((item, id) => {
                if (finalMap.has(id)) {
                    let row = finalMap.get(id);
                    row[todayStr] = item.price;
                    row['ê³„ì•½ì¢…ë£Œì¼'] = item.endDate;
                    row['ê·œê²©'] = item.spec;
                    if (item.company) row['ì—…ì²´ëª…'] = item.company;
                } else {
                    let newRow = {
                        'ì—…ì²´ëª…': item.company,
                        'ì‹ë³„ë²ˆí˜¸': item.id,
                        'ê·œê²©': item.spec,
                        'ê³„ì•½ì¢…ë£Œì¼': item.endDate,
                        [todayStr]: item.price
                    };
                    finalMap.set(id, newRow);
                }
            });

            mergedData = Array.from(finalMap.values());
            calculateStatus(todayStr);
            updateFilters();
            renderTable();
        }

        // ê°€ê²© ìš°ì„  ì—…ë°ì´íŠ¸ ë¡œì§
        function updateMapWithHighPrice(map, id, newItem) {
            if (map.has(id)) {
                const existingItem = map.get(id);
                // ë” ë¹„ì‹¼ ê°€ê²©ì´ë©´ êµì²´
                if (newItem.price > existingItem.price) {
                    map.set(id, newItem);
                }
                // ê°€ê²©ì´ ê°™ìœ¼ë©´? 'í˜„ì¥ì„¤ì¹˜'ê°€ ìˆìœ¼ë©´ êµì²´ (í˜¹ì‹œ ëª°ë¼ì„œ)
                else if (newItem.price === existingItem.price) {
                    const newDel = newItem.delivery || "";
                    const oldDel = existingItem.delivery || "";
                    if (newDel.includes("í˜„ì¥") && !oldDel.includes("í˜„ì¥")) {
                        map.set(id, newItem);
                    }
                }
            } else {
                map.set(id, newItem);
            }
        }

        // [í•µì‹¬] ì‹ë³„ë²ˆí˜¸ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„/ì•„ë˜ë¥¼ êµ¬ë¶„í•˜ì—¬ íŒŒì‹±
        function parseChunk(lines, idIndexInChunk) {
            let item = { company: '', id: '', spec: '', price: 0, endDate: '', delivery: '' };

            // 1. ì‹ë³„ë²ˆí˜¸ í™•ì¸
            const idLine = lines[idIndexInChunk];
            if (lines[idIndexInChunk + 1] && /^\d{8,}$/.test(lines[idIndexInChunk + 1])) {
                item.id = lines[idIndexInChunk + 1];
            } else {
                const match = idLine.match(/\d{8,}/);
                if (match) item.id = match[0];
            }
            if (!item.id) return item;

            // 2. ì—…ì²´ëª… (ì‹ë³„ë²ˆí˜¸ë³´ë‹¤ 'ìœ„ìª½' ë¼ì¸ì—ì„œ íƒìƒ‰)
            for (let i = 0; i <= idIndexInChunk; i++) {
                if (/^[ê°€-í£a-zA-Z]+\(\d{8,}\)$/.test(lines[i]) && lines[i + 1]) {
                    item.company = lines[i + 1];
                    break;
                }
                if ((lines[i].includes("ì£¼ì‹íšŒì‚¬") || lines[i].includes("(ì£¼)")) && lines[i].length < 20) {
                    item.company = lines[i];
                }
            }

            // 3. ê°€ê²© (ë°˜ë“œì‹œ ì‹ë³„ë²ˆí˜¸ë³´ë‹¤ 'ì•„ë˜ìª½' ë¼ì¸ì—ì„œ íƒìƒ‰)
            // ì •ê·œì‹: ìˆ«ì+ì½¤ë§ˆ+ê³µë°±ê°€ëŠ¥+ì› (ì˜ˆ: 545,000ì›, 545,000 ì›)
            for (let i = idIndexInChunk + 1; i < lines.length; i++) {
                const l = lines[i];
                // "ì›"ìœ¼ë¡œ ëë‚˜ê±°ë‚˜ í¬í•¨ëœ ìˆ«ì ì°¾ê¸° (ìµœì €/ìµœê³  ì œì™¸)
                if (/[0-9,]+\s*ì›/.test(l) && !l.includes("ìµœì €") && !l.includes("ìµœê³ ")) {
                    const match = l.match(/([0-9,]+)\s*ì›/);
                    if (match) {
                        item.price = parseInt(match[1].replace(/,/g, ''));
                        break; // ê°€ê²© ì°¾ìœ¼ë©´ ì¤‘ë‹¨ (ì²«ë²ˆì§¸ ê°€ê²©ì´ ë³´í†µ í•´ë‹¹ ì œí’ˆ ê°€ê²©)
                    }
                }
            }

            // 4. ì¸ë„ì¡°ê±´ (ì „ì²´ íƒìƒ‰)
            const delKeyword = lines.find(l => l.includes("í˜„ì¥ì„¤ì¹˜ë„") || l.includes("ë‚©í’ˆì¥ì†Œë„"));
            if (delKeyword) item.delivery = delKeyword;

            // 5. ê·œê²© (ì „ì²´ íƒìƒ‰)
            const categoryVal = document.getElementById('categorySelect').value;
            const specLine = lines.find(l =>
                (l.startsWith(categoryVal) && l.includes(",")) ||
                (l.includes(",") && l.length > 25 && !l.includes("ê°€ê²©ë²”ìœ„") && !l.includes("ë°”ë¡œê°€ê¸°") && !l.includes("ì¸ë„ì¡°ê±´"))
            );
            item.spec = specLine || '';

            // 6. ì¢…ë£Œì¼
            const dateLine = lines.find(l => /20\d{2}\.\d{2}\.\d{2}/.test(l) && !l.includes("ë‚©í’ˆê¸°í•œ"));
            if (dateLine) item.endDate = dateLine;

            return item;
        }

        function calculateStatus(currentDate) {
            const curIdx = dateColumns.indexOf(currentDate);
            const prevDate = curIdx > 0 ? dateColumns[curIdx - 1] : null;

            mergedData.forEach(row => {
                const curP = parseInt(row[currentDate]) || 0;
                if (curP === 0) {
                    row['ìƒíƒœ'] = 'SAME'; row['ë³€ë™ì•¡'] = 0; return;
                }
                const prevP = prevDate ? (parseInt(row[prevDate]) || 0) : 0;
                if (prevP === 0) {
                    row['ìƒíƒœ'] = 'NEW'; row['ë³€ë™ì•¡'] = 0;
                } else {
                    const diff = curP - prevP;
                    row['ë³€ë™ì•¡'] = diff;
                    if (diff > 0) row['ìƒíƒœ'] = 'UP';
                    else if (diff < 0) row['ìƒíƒœ'] = 'DOWN';
                    else row['ìƒíƒœ'] = 'SAME';
                }
            });
        }

        function toggleSpecView() {
            isSpecExpanded = !isSpecExpanded;
            const btn = document.getElementById('specToggleBtn');
            if (isSpecExpanded) {
                btn.innerText = ">< ê·œê²© ì¢ê²Œë³´ê¸°";
                btn.classList.replace('btn-indigo', 'btn-gray');
            } else {
                btn.innerText = "â†” ê·œê²© ì „ì²´ë³´ê¸°";
                btn.classList.replace('btn-gray', 'btn-indigo');
            }
            renderTable();
        }

        function resetData() {
            if (!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            mergedData = [];
            dateColumns = [];
            document.getElementById('rawData').value = "";
            document.getElementById('prevFile').value = "";
            document.getElementById('fileStatus').innerText = "";
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('companyFilter').innerHTML = '<option value="">ì „ì²´ ì—…ì²´</option>';
        }

        function updateFilters() {
            const companySet = new Set();
            mergedData.forEach(row => { if (row['ì—…ì²´ëª…']) companySet.add(row['ì—…ì²´ëª…']); });
            const sortedComp = Array.from(companySet).sort();
            const sel = document.getElementById("companyFilter");
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">ì „ì²´ ì—…ì²´</option>';
            sortedComp.forEach(c => {
                const op = document.createElement("option");
                op.value = c; op.innerText = c;
                sel.appendChild(op);
            });
            sel.value = currentVal;
        }

        function renderTable() {
            const compVal = document.getElementById("companyFilter").value;
            const statVal = document.getElementById("statusFilter").value;
            const todayKey = document.getElementById("todayDate").value;

            document.getElementById("sortLabel").innerText = todayKey;

            const filtered = mergedData.filter(row => {
                const matchComp = (compVal === "") || (row['ì—…ì²´ëª…'] === compVal);
                const matchStat = (statVal === "") || (row['ìƒíƒœ'] === statVal);
                return matchComp && matchStat;
            });

            filtered.sort((a, b) => {
                const valA = a[todayKey];
                const valB = b[todayKey];
                const priceA = valA ? parseInt(String(valA).replace(/,/g, '')) : 0;
                const priceB = valB ? parseInt(String(valB).replace(/,/g, '')) : 0;
                if (priceA !== priceB) return priceA - priceB;
                return (a['ì—…ì²´ëª…'] || "").localeCompare(b['ì—…ì²´ëª…'] || "");
            });

            const thead = document.querySelector("#resultTable thead");
            let thHTML = `<tr>
            <th style="width:50px;">ìƒíƒœ</th>
            <th style="width:130px;">ì—…ì²´ëª…</th>
            <th style="width:80px;">ì‹ë³„ë²ˆí˜¸</th>
            <th style="min-width:200px;">ê·œê²©</th>`;

            dateColumns.forEach(date => {
                const isSortKey = (date === todayKey);
                const classAttr = isSortKey ? 'class="sorted-header"' : '';
                const icon = isSortKey ? ' â–²' : '';
                thHTML += `<th ${classAttr} style="width:90px; text-align:right;">${date}${icon}</th>`;
            });

            thHTML += `<th style="width:80px; text-align:right;">ë³€ë™ì•¡</th><th style="width:90px;">ì¢…ë£Œì¼</th></tr>`;
            thead.innerHTML = thHTML;

            const tbody = document.querySelector("#resultTable tbody");
            tbody.innerHTML = "";

            const specClass = isSpecExpanded ? 'spec-cell-full' : 'spec-cell-compact';

            filtered.forEach(row => {
                const tr = document.createElement("tr");
                let statusBadge = `<span class="text-gray-400">-</span>`;
                if (row['ìƒíƒœ'] === 'UP') { statusBadge = `ğŸ”º`; tr.classList.add("bg-red-row"); }
                else if (row['ìƒíƒœ'] === 'DOWN') { statusBadge = `ğŸ”»`; tr.classList.add("bg-green-row"); }
                else if (row['ìƒíƒœ'] === 'NEW') { statusBadge = `<span class="text-blue-600 font-bold">N</span>`; }

                let html = `
                <td style="text-align:center;">${statusBadge}</td>
                <td style="font-weight:bold; color:#374151;">${row['ì—…ì²´ëª…'] || ''}</td>
                <td style="text-align:center;">
                    <div class="cursor-pointer text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1 group" 
                         onclick="copyAndOpenG2B('${row['ì‹ë³„ë²ˆí˜¸']}')" 
                         title="í´ë¦­ ì‹œ ì‹ë³„ë²ˆí˜¸ ë³µì‚¬ í›„ ë‚˜ë¼ì¥í„° ì‡¼í•‘ëª° ì´ë™">
                         <span>${row['ì‹ë³„ë²ˆí˜¸']}</span>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 00-2 2h10a2 2 0 00-2-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </div>
                </td>
                <td class="${specClass} ${row['ì‹ë³„ë²ˆí˜¸'] && document.getElementById('categorySelect').value === 'ë°ìŠ¤í¬í†±ì»´í“¨í„°' ? 'cursor-pointer hover:bg-yellow-50 hover:text-blue-700' : ''}" 
                    title="${row['ê·œê²©'] || ''} ${document.getElementById('categorySelect').value === 'ë°ìŠ¤í¬í†±ì»´í“¨í„°' ? '(í´ë¦­ ì‹œ ìƒì„¸ì •ë³´ ë³´ê¸°)' : ''}" 
                    style="font-size:11px; color:#555;"
                    onclick="${document.getElementById('categorySelect').value === 'ë°ìŠ¤í¬í†±ì»´í“¨í„°' ? `showDesktopDetails('${row['ì‹ë³„ë²ˆí˜¸']}')` : ''}">
                    ${row['ê·œê²©'] || ''}
                </td>
            `;

                dateColumns.forEach(date => {
                    const val = row[date];
                    const displayVal = val ? parseInt(String(val).replace(/,/g, '')).toLocaleString() : '-';
                    const isToday = (date === todayKey);
                    let colorStyle = "";
                    if (isToday) {
                        if (row['ìƒíƒœ'] === 'UP') colorStyle = "color:#dc2626; font-weight:bold;";
                        else if (row['ìƒíƒœ'] === 'DOWN') colorStyle = "color:#16a34a; font-weight:bold;";
                        else if (row['ìƒíƒœ'] === 'NEW') colorStyle = "color:#2563eb; font-weight:bold;";
                    }
                    html += `<td style="text-align:right; ${colorStyle}">${displayVal}</td>`;
                });

                const diff = row['ë³€ë™ì•¡'];
                let diffStr = (diff > 0) ? `+${parseInt(diff).toLocaleString()}` : (diff ? parseInt(diff).toLocaleString() : '-');
                let diffColor = (diff > 0) ? 'color:#dc2626;' : (diff < 0 ? 'color:#16a34a;' : 'color:#999;');

                html += `<td style="text-align:right; font-weight:bold; ${diffColor}">${diffStr}</td><td style="font-size:11px;">${row['ê³„ì•½ì¢…ë£Œì¼'] || ''}</td>`;
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });

            document.getElementById("resultArea").classList.remove("hidden");
            document.getElementById("count").innerText = filtered.length;
        }

        // ë°ìŠ¤í¬í†± ìƒì„¸ ì •ë³´ ë³´ê¸° ê´€ë ¨ ë³€ìˆ˜
        let desktopWorkbook = null;

        async function showDesktopDetails(id) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');

            modal.style.display = 'flex';
            modalTitle.innerText = `ìƒì„¸ ê·œê²© ì •ë³´ (ì‹ë³„ë²ˆí˜¸: ${id})`;
            modalBody.innerHTML = `
                <div class="flex items-center justify-center p-10">
                    <div class="loading-spinner"></div>
                    <span class="ml-3 text-gray-600">ë°ì´í„°ë¥¼ ì°¾ëŠ” ì¤‘...</span>
                </div>`;

            try {
                // 1. ì—‘ì…€ íŒŒì¼ ë¡œë“œ (ìµœì´ˆ 1íšŒë§Œ)
                if (!desktopWorkbook) {
                    const excelPath = `data/desktop_db.xlsx`;

                    try {
                        const response = await fetch(excelPath);
                        if (!response.ok) {
                            throw new Error(`íŒŒì¼ ì‘ë‹µ ì˜¤ë¥˜ (Status: ${response.status})`);
                        }
                        const arrayBuffer = await response.arrayBuffer();
                        desktopWorkbook = XLSX.read(arrayBuffer, { type: 'array' });
                    } catch (fetchErr) {
                        console.warn("ìë™ ë¡œë“œ ì‹¤íŒ¨, ìˆ˜ë™ ì„ íƒ í™œì„±í™”:", fetchErr);
                        const footer = document.getElementById('modalFooter');
                        if (footer) footer.classList.remove('hidden');
                        throw new Error(`ì—‘ì…€ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (CORS ë³´ì•ˆ ë˜ëŠ” íŒŒì¼ ì—†ìŒ)\ní•˜ë‹¨ì˜ 'íŒŒì¼ ì„ íƒ' ë²„íŠ¼ìœ¼ë¡œ 'data/desktop_db.xlsx' íŒŒì¼ì„ ì§ì ‘ ì„ íƒí•´ì£¼ì„¸ìš”.`);
                    }
                }

                // 2. ëª¨ë“  ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê²€ìƒ‰ ì‹œë„
                let foundData = null;
                let foundSheetName = "";
                let foundHeader1 = [];
                let foundHeader2 = [];

                for (const sheetName of desktopWorkbook.SheetNames) {
                    const sheet = desktopWorkbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (data.length < 5) continue;

                    // 2.1 "ë¬¼í’ˆ ì‹ë³„ë²ˆí˜¸" ì»¬ëŸ¼ ë™ì  ì°¾ê¸° (ìƒë‹¨ 150í–‰ ì´ë‚´)
                    let idColIndex = -1;
                    let h2Idx = -1;
                    for (let r = 0; r < Math.min(data.length, 150); r++) {
                        const row = data[r] || [];
                        const foundIdx = row.findIndex(h => String(h || "").replace(/\s/g, "").includes("ë¬¼í’ˆì‹ë³„ë²ˆí˜¸"));
                        if (foundIdx !== -1) {
                            idColIndex = foundIdx;
                            h2Idx = r;
                            break;
                        }
                    }

                    if (idColIndex !== -1) {
                        const searchId = String(id).trim().replace(/,/g, "");
                        const targetRow = data.find(row => {
                            const cellValue = String(row[idColIndex] || "").trim().replace(/,/g, "");
                            return cellValue === searchId;
                        });

                        if (targetRow) {
                            foundData = targetRow;
                            foundSheetName = sheetName;

                            // 2.2 ë¶€ëª¨ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ì¶œ (ì‚¬ìš©ì ìš”ì²­: 8í–‰ ê¸°ì¤€ 7í–‰ì˜ ìë£Œê°€ ì—†ìœ¼ë©´ ì „ ì»¬ëŸ¼ì˜ 7í–‰ ì‚¬ìš©)
                            const parentRow = data[h2Idx - 1] || [];
                            const categoryMap = new Array(foundHeader2.length).fill("");
                            let lastValue = "";

                            for (let c = 0; c < foundHeader2.length; c++) {
                                const cell = String(parentRow[c] || "").trim();
                                if (cell !== "") {
                                    lastValue = cell;
                                }
                                categoryMap[c] = lastValue;
                            }

                            foundHeader1 = categoryMap; // í™•ì •ëœ ì¹´í…Œê³ ë¦¬ ë§µ ì‚¬ìš©
                            foundHeader2 = data[h2Idx] || [];
                            break;
                        }
                    }
                }

                if (!foundData) {
                    throw new Error(`ëª¨ë“  ì‹œíŠ¸(${desktopWorkbook.SheetNames.join(", ")})ë¥¼ ê²€ìƒ‰í–ˆìœ¼ë‚˜ ì‹ë³„ë²ˆí˜¸(${id})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }

                // 3. í…Œì´ë¸” ìƒì„± (ì„¸ë¡œí˜•)
                let tableHTML = `<table class="min-w-full border-collapse border border-gray-200 shadow-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border border-gray-300 p-2 w-1/3 text-xs text-gray-500 uppercase tracking-wider">êµ¬ë¶„ (í•­ëª©)</th>
                            <th class="border border-gray-300 p-2 text-xs text-gray-500 uppercase tracking-wider">ìƒì„¸ ê·œê²© ë‚´ìš©</th>
                        </tr>
                    </thead>
                    <tbody>`;

                let lastDisplayedParent = "";
                foundHeader2.forEach((h, idx) => {
                    if (!h) return;

                    const headerText = String(h).trim();
                    // "ë¬¼í’ˆ ì‹ë³„ë²ˆí˜¸" í–‰ ì‚­ì œ
                    if (headerText.replace(/\s/g, "").includes("ë¬¼í’ˆì‹ë³„ë²ˆí˜¸")) return;

                    const val = foundData[idx] || '-';
                    const parent = foundHeader1[idx] || '';

                    // ì¹´í…Œê³ ë¦¬ê°€ ì¡´ì¬í•˜ê³  ì´ì „ê³¼ ë‹¬ë¼ì§€ë©´ íŒŒë€ìƒ‰ êµ¬ë¶„ í–‰ ì¶”ê°€
                    if (parent && parent !== lastDisplayedParent) {
                        tableHTML += `
                            <tr>
                                <td colspan="2" class="bg-blue-600 p-2 text-white font-bold text-sm border border-blue-700 text-center uppercase">
                                    ${parent}
                                </td>
                            </tr>`;
                        lastDisplayedParent = parent;
                    }

                    tableHTML += `
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50 font-semibold text-gray-700 text-sm">
                                ${headerText}
                            </td>
                            <td class="border border-gray-300 p-2 text-gray-800 text-sm">
                                ${val}
                            </td>
                        </tr>`;
                });

                tableHTML += `</tbody></table>`;
                modalBody.innerHTML = tableHTML;

            } catch (error) {
                modalBody.innerHTML = `
                    <div class="p-8 text-center text-red-600 font-bold">
                        ì˜¤ë¥˜: ${error.message}
                    </div>`;
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function (event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // ìˆ˜ë™ ì—‘ì…€ íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        document.getElementById('excelDbFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                desktopWorkbook = XLSX.read(data, { type: 'array' });
                document.getElementById('modalFooter').classList.add('hidden');
                // í˜„ì¬ ì—´ë¦° ëª¨ë‹¬ì˜ IDë¡œ ë‹¤ì‹œ ê²€ìƒ‰ ì‹œë„
                const currentId = document.getElementById('modalTitle').innerText.match(/\d+/)[0];
                showDesktopDetails(currentId);
            };
            reader.readAsArrayBuffer(file);
        });

        async function copyAndOpenG2B(id) {
            try {
                await navigator.clipboard.writeText(id);
                // alert(`ì‹ë³„ë²ˆí˜¸(${id})ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nê²€ìƒ‰ì°½ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”.`);
                window.open("http://shop.g2b.go.kr/", "_blank");
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                window.open("http://shop.g2b.go.kr/", "_blank");
            }
        }

        function downloadCSV() {
            if (mergedData.length === 0) return;
            const category = document.getElementById('categorySelect').value;
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            const finalCsvData = mergedData.map(row => {
                let item = { 'ìƒíƒœ': row['ìƒíƒœ'], 'ì—…ì²´ëª…': row['ì—…ì²´ëª…'], 'ì‹ë³„ë²ˆí˜¸': row['ì‹ë³„ë²ˆí˜¸'], 'ê·œê²©': row['ê·œê²©'] };
                dateColumns.forEach(d => item[d] = row[d]);
                item['ë³€ë™ì•¡'] = row['ë³€ë™ì•¡'];
                item['ê³„ì•½ì¢…ë£Œì¼'] = row['ê³„ì•½ì¢…ë£Œì¼'];
                return item;
            });
            const csv = Papa.unparse(finalCsvData, { quotes: true });
            const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `ì¡°ë‹¬ì²­_${category}_ê°€ê²©ëŒ€ì¥_${today}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

</body>

</html>