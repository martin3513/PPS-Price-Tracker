<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°ë‹¬ì²­ ë°ì´í„° í†µí•© ê´€ë¦¬ê¸° (ê°€ê²© ë‚®ì€ìˆœ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 98%; margin: 0 auto; padding: 20px; }
        
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 13px; }
        select, input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-wrapper { 
            overflow-x: auto; 
            max-height: 700px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            border-radius: 8px; 
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        table { border-collapse: separate; border-spacing: 0; background: white; font-size: 12px; white-space: nowrap; }
        th, td { border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; padding: 8px 10px; vertical-align: middle; }
        
        /* í—¤ë” ê³ ì • (Sticky) */
        thead th { position: sticky; top: 0; z-index: 30; background-color: #f3f4f6; border-top: 1px solid #e5e7eb; height: 40px; }

        /* ì™¼ìª½ ê³ ì • ì»¬ëŸ¼ */
        th:nth-child(1), td:nth-child(1) { position: sticky; left: 0; z-index: 20; background-color: #f9fafb; border-right: 2px solid #e5e7eb; text-align: center;}
        th:nth-child(2), td:nth-child(2) { position: sticky; left: 50px; z-index: 20; background-color: #f9fafb; border-right: 2px solid #e5e7eb; }
        th:nth-child(3), td:nth-child(3) { position: sticky; left: 180px; z-index: 20; background-color: #f9fafb; border-right: 2px solid #dedede; }

        /* êµì°¨ì  z-index ì²˜ë¦¬ */
        thead th:nth-child(1), thead th:nth-child(2), thead th:nth-child(3) { z-index: 40; background-color: #e5e7eb; }

        /* ë²„íŠ¼ ë° ê°•ì¡° */
        .btn { padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; border: none; font-size: 13px; transition: 0.2s; }
        .btn-blue { background-color: #2563eb; }
        .btn-green { background-color: #16a34a; }
        .btn-red { background-color: #ef4444; } /* ë¦¬ì…‹ ë²„íŠ¼ìš© */
        .btn:hover { opacity: 0.9; }

        .bg-red-row { background-color: #fef2f2 !important; }
        .bg-green-row { background-color: #f0fdf4 !important; }
        .sorted-header { background-color: #dbeafe !important; color: #1e40af; border-bottom: 2px solid #2563eb; }

        .filter-box { background-color: #eff6ff; border: 1px solid #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;}
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“Š ì¡°ë‹¬ì²­ ë°ì´í„° í†µí•© ê´€ë¦¬ê¸°</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h3 class="font-bold text-gray-700 mb-2">ğŸ“‚ 1. ì´ì „ íˆìŠ¤í† ë¦¬ íŒŒì¼ (CSV)</h3>
            <input type="file" id="prevFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
            <div id="fileStatus" class="mt-2 text-xs text-blue-600 font-bold h-4"></div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h3 class="font-bold text-gray-700 mb-2">ğŸ“ 2. ì˜¤ëŠ˜ ë°ì´í„° ì…ë ¥</h3>
            <div class="flex gap-2 mb-2">
                <select id="categorySelect" class="flex-1">
                    <option value="ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ">ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ</option>
                    <option value="ë°ìŠ¤í¬í†±ì»´í“¨í„°">ë°ìŠ¤í¬í†±ì»´í“¨í„°</option>
                    <option value="ëª¨ë‹ˆí„°">ëª¨ë‹ˆí„°</option>
                    <option value="ë…¸íŠ¸ë¶">ë…¸íŠ¸ë¶</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <input type="date" id="todayDate" class="flex-1" onchange="renderTable()">
            </div>
            <textarea id="rawData" placeholder="ì¡°ë‹¬ì²­ ëª©ë¡ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
            <div class="flex gap-2 mt-2">
                <button onclick="processData()" class="w-full btn btn-blue">ë°ì´í„° ë¶„ì„ ë° ë³‘í•©</button>
                <button onclick="resetData()" class="w-1/4 btn btn-red">ğŸ”„ ë¦¬ì…‹</button>
            </div>
        </div>
    </div>

    <div id="resultArea" class="bg-white p-4 rounded-lg shadow hidden">
        
        <div class="flex flex-wrap justify-between items-end mb-2">
            <h2 class="text-xl font-bold text-gray-800">ë¶„ì„ ê²°ê³¼ (<span id="count">0</span>ê±´)</h2>
            <button onclick="downloadCSV()" class="btn btn-green">ğŸ’¾ ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div class="filter-box">
            <div>
                <label class="font-bold text-gray-700 mr-2">ğŸ¢ ì—…ì²´ëª…:</label>
                <select id="companyFilter" onchange="renderTable()" style="width: 150px;">
                    <option value="">ì „ì²´ ì—…ì²´</option>
                </select>
            </div>
            <div>
                <label class="font-bold text-gray-700 mr-2">ğŸ“ˆ ìƒíƒœ:</label>
                <select id="statusFilter" onchange="renderTable()" style="width: 120px;">
                    <option value="">ì „ì²´ ë³´ê¸°</option>
                    <option value="UP">ì¸ìƒ (ğŸ”º)</option>
                    <option value="DOWN">ì¸í•˜ (ğŸ”»)</option>
                    <option value="NEW">ì‹ ê·œ (ğŸ†•)</option>
                    <option value="SAME">ë³€ë™ì—†ìŒ</option>
                </select>
            </div>
            <div class="text-xs text-blue-800 ml-auto font-bold bg-blue-100 px-3 py-1 rounded border border-blue-200">
                ì •ë ¬: <span id="sortLabel">ì˜¤ëŠ˜ ë‚ ì§œ</span> ê°€ê²© ë‚®ì€ìˆœ â–²
            </div>
        </div>

        <div class="table-wrapper">
            <table id="resultTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.getElementById('todayDate').valueAsDate = new Date();

    let mergedData = [];       
    let dateColumns = [];      
    const fixedCols = ['ìƒíƒœ', 'ì—…ì²´ëª…', 'ì‹ë³„ë²ˆí˜¸', 'ê·œê²©', 'ê³„ì•½ì¢…ë£Œì¼', 'ë³€ë™ì•¡', 'ë¹„ê³ '];

    // 1. CSV íŒŒì¼ ì½ê¸°
    document.getElementById('prevFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if(results.data.length === 0) return;
                const headers = results.meta.fields;
                dateColumns = headers.filter(h => !fixedCols.includes(h)).sort();
                mergedData = results.data;
                document.getElementById('fileStatus').innerText = `âœ… ê¸°ì¡´ ë°ì´í„° ${mergedData.length}ê±´ ë¡œë“œë¨`;
                updateFilters();
                renderTable();
            }
        });
    });

    // 2. ë°ì´í„° ì²˜ë¦¬
    function processData() {
        const rawText = document.getElementById('rawData').value;
        const todayStr = document.getElementById('todayDate').value;
        
        if (!dateColumns.includes(todayStr) && rawText.trim()) {
            dateColumns.push(todayStr);
            dateColumns.sort();
        }

        const todayMap = new Map();
        if (rawText.trim()) {
            // **[ë°ì´í„° ë¶„ë¦¬ íŒ¨í„´]**
            // 1. ì ì„ (----)
            // 2. "ëŒ€" ë¼ëŠ” ë‹¨ìœ„ê°€ ì¤„ë°”ê¿ˆê³¼ í•¨ê»˜ ìˆì„ ë•Œ (ì˜ˆ: \n0\nëŒ€\n ë˜ëŠ” ê·¸ëƒ¥ \nëŒ€\n)
            // 3. "ì¶”ê°€ì„ íƒ" ë¬¸êµ¬
            const blocks = rawText.split(/ì¶”ê°€ì„ íƒ\(.*?\)|-{10,}|\n\s*\d*\s*\n\s*ëŒ€\s*(?:\n|$)/);
            
            blocks.forEach(block => {
                const item = parseBlock(block);
                if (item.id && item.price) {
                    todayMap.set(item.id, item);
                }
            });
        }

        let finalMap = new Map();
        mergedData.forEach(row => { if(row['ì‹ë³„ë²ˆí˜¸']) finalMap.set(row['ì‹ë³„ë²ˆí˜¸'], row); });

        todayMap.forEach((item, id) => {
            if (finalMap.has(id)) {
                let row = finalMap.get(id);
                row[todayStr] = item.price;
                row['ê³„ì•½ì¢…ë£Œì¼'] = item.endDate;
                if(item.company) row['ì—…ì²´ëª…'] = item.company; 
                // ê·œê²©ì´ ë” ê¸´ ì •ë³´ë¡œ ë“¤ì–´ì˜¤ë©´ ì—…ë°ì´íŠ¸
                if(item.spec.length > (row['ê·œê²©']||"").length) row['ê·œê²©'] = item.spec;
            } else {
                let newRow = {
                    'ì—…ì²´ëª…': item.company,
                    'ì‹ë³„ë²ˆí˜¸': item.id,
                    'ê·œê²©': item.spec,
                    'ê³„ì•½ì¢…ë£Œì¼': item.endDate,
                    [todayStr]: item.price
                };
                finalMap.set(id, newRow);
            }
        });

        mergedData = Array.from(finalMap.values());
        calculateStatus(todayStr);
        updateFilters();
        renderTable();
    }

    // [í•µì‹¬] íŒŒì‹± ë¡œì§
    function parseBlock(block) {
        const lines = block.split('\n').map(l => l.trim()).filter(l => l);
        let item = { company: '', id: '', spec: '', price: 0, endDate: '' };
        if (lines.length < 3) return item;

        // 1. ì—…ì²´ëª…: í’ˆëª©ëª…(ì½”ë“œ) ë‹¤ìŒ ì¤„ì— ì£¼ë¡œ ìœ„ì¹˜
        const catIdx = lines.findIndex(l => /^[ê°€-í£a-zA-Z]+\(\d+\)$/.test(l));
        if (catIdx !== -1 && lines[catIdx + 1]) {
            item.company = lines[catIdx + 1];
        } else {
            // íŒ¨í„´ì´ ì—†ìœ¼ë©´ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰
            const comIdx = lines.findIndex(l => l.includes("ì£¼ì‹íšŒì‚¬") || l.includes("(ì£¼)") || l.includes("ì»´íŠ¸ë¦¬") || l.includes("ì»´ë²„ìŠ¤í…Œí¬"));
            if(comIdx!==-1) item.company = lines[comIdx];
        }

        // 2. ì‹ë³„ë²ˆí˜¸
        const idIdx = lines.indexOf("ì‹ë³„ë²ˆí˜¸");
        if(idIdx !== -1) item.id = lines[idIdx+1];

        // 3. ê·œê²©: í’ˆëª©ëª…ì´ë‚˜ ì½¤ë§ˆê°€ í¬í•¨ëœ ê¸´ ì¤„
        // ìš°ì„ ìˆœìœ„: ì¹´í…Œê³ ë¦¬ëª…ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ > ì½¤ë§ˆê°€ ë§ì€ ì¤„
        const categoryVal = document.getElementById('categorySelect').value || "ì¸í„°ë™í‹°ë¸Œ";
        let specLine = lines.find(l => l.startsWith(categoryVal + ","));
        if (!specLine) {
            specLine = lines.find(l => (l.includes(",") && l.length > 20));
        }
        item.spec = specLine || '';

        // 4. ê°€ê²©
        const priceLine = lines.find(l => /^[0-9,]+ì›$/.test(l));
        if (priceLine) item.price = parseInt(priceLine.replace(/[^0-9]/g, ''));

        // 5. ì¢…ë£Œì¼
        const dateLine = lines.find(l => /20\d{2}\.\d{2}\.\d{2}/.test(l) && !l.includes("ë‚©í’ˆê¸°í•œ"));
        if(dateLine) item.endDate = dateLine;

        return item;
    }

    function calculateStatus(currentDate) {
        const curIdx = dateColumns.indexOf(currentDate);
        const prevDate = curIdx > 0 ? dateColumns[curIdx - 1] : null;

        mergedData.forEach(row => {
            const curP = parseInt(row[currentDate]) || 0;
            if (curP === 0) {
                row['ìƒíƒœ'] = 'SAME'; row['ë³€ë™ì•¡'] = 0; return; 
            }
            const prevP = prevDate ? (parseInt(row[prevDate]) || 0) : 0;
            if (prevP === 0) {
                row['ìƒíƒœ'] = 'NEW'; row['ë³€ë™ì•¡'] = 0;
            } else {
                const diff = curP - prevP;
                row['ë³€ë™ì•¡'] = diff;
                if (diff > 0) row['ìƒíƒœ'] = 'UP';
                else if (diff < 0) row['ìƒíƒœ'] = 'DOWN';
                else row['ìƒíƒœ'] = 'SAME';
            }
        });
    }

    // ë¦¬ì…‹ ê¸°ëŠ¥
    function resetData() {
        if(!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) return;
        
        mergedData = [];
        dateColumns = [];
        document.getElementById('rawData').value = "";
        document.getElementById('prevFile').value = ""; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
        document.getElementById('fileStatus').innerText = "";
        document.getElementById('resultArea').classList.add('hidden');
        document.getElementById('companyFilter').innerHTML = '<option value="">ì „ì²´ ì—…ì²´</option>';
        alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function updateFilters() {
        const companySet = new Set();
        mergedData.forEach(row => { if(row['ì—…ì²´ëª…']) companySet.add(row['ì—…ì²´ëª…']); });
        const sortedComp = Array.from(companySet).sort();

        const sel = document.getElementById("companyFilter");
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">ì „ì²´ ì—…ì²´</option>';
        sortedComp.forEach(c => {
            const op = document.createElement("option");
            op.value = c; op.innerText = c;
            sel.appendChild(op);
        });
        sel.value = currentVal; 
    }

    function renderTable() {
        const compVal = document.getElementById("companyFilter").value;
        const statVal = document.getElementById("statusFilter").value;
        const todayKey = document.getElementById("todayDate").value;

        document.getElementById("sortLabel").innerText = todayKey;

        // í•„í„°ë§
        const filtered = mergedData.filter(row => {
            const matchComp = (compVal === "") || (row['ì—…ì²´ëª…'] === compVal);
            const matchStat = (statVal === "") || (row['ìƒíƒœ'] === statVal);
            return matchComp && matchStat;
        });

        // **ì •ë ¬ ë¡œì§ ìˆ˜ì •ë¨: ì˜¤ë¦„ì°¨ìˆœ (ê°€ê²© ë‚®ì€ìˆœ)**
        filtered.sort((a, b) => {
            const valA = a[todayKey];
            const valB = b[todayKey];
            const priceA = valA ? parseInt(String(valA).replace(/,/g, '')) : 0;
            const priceB = valB ? parseInt(String(valB).replace(/,/g, '')) : 0;
            
            // 0ì›ì¸ ê²½ìš°(ë°ì´í„° ì—†ìŒ) ë§¨ ë’¤ë¡œ ë³´ë‚¼ì§€ ì—¬ë¶€ëŠ” ì„ íƒì‚¬í•­ì´ë‚˜, ì—¬ê¸°ì„  ì¼ë°˜ ì •ë ¬
            if (priceA !== priceB) return priceA - priceB; // Low -> High (ì˜¤ë¦„ì°¨ìˆœ)
            return (a['ì—…ì²´ëª…']||"").localeCompare(b['ì—…ì²´ëª…']||"");
        });

        // í…Œì´ë¸” ê·¸ë¦¬ê¸°
        const thead = document.querySelector("#resultTable thead");
        let thHTML = `<tr>
            <th style="width:50px;">ìƒíƒœ</th>
            <th style="width:130px;">ì—…ì²´ëª…</th>
            <th style="width:80px;">ì‹ë³„ë²ˆí˜¸</th>
            <th style="min-width:200px;">ê·œê²©</th>`;
        
        dateColumns.forEach(date => {
            const isSortKey = (date === todayKey);
            const classAttr = isSortKey ? 'class="sorted-header"' : '';
            const icon = isSortKey ? ' â–²' : ''; // ì˜¤ë¦„ì°¨ìˆœ ì•„ì´ì½˜
            thHTML += `<th ${classAttr} style="width:90px; text-align:right;">${date}${icon}</th>`;
        });

        thHTML += `<th style="width:80px; text-align:right;">ë³€ë™ì•¡</th><th style="width:90px;">ì¢…ë£Œì¼</th></tr>`;
        thead.innerHTML = thHTML;

        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";

        filtered.forEach(row => {
            const tr = document.createElement("tr");
            let statusBadge = `<span class="text-gray-400">-</span>`;
            if(row['ìƒíƒœ'] === 'UP') { statusBadge = `ğŸ”º`; tr.classList.add("bg-red-row"); }
            else if(row['ìƒíƒœ'] === 'DOWN') { statusBadge = `ğŸ”»`; tr.classList.add("bg-green-row"); }
            else if(row['ìƒíƒœ'] === 'NEW') { statusBadge = `<span class="text-blue-600 font-bold">N</span>`; }

            let html = `
                <td style="text-align:center;">${statusBadge}</td>
                <td style="font-weight:bold; color:#374151;">${row['ì—…ì²´ëª…']||''}</td>
                <td>${row['ì‹ë³„ë²ˆí˜¸']}</td>
                <td title="${row['ê·œê²©']}" style="font-size:11px; color:#555;">${(row['ê·œê²©']||'').substring(0, 30)}...</td>
            `;

            dateColumns.forEach(date => {
                const val = row[date];
                const displayVal = val ? parseInt(String(val).replace(/,/g,'')).toLocaleString() : '-';
                const isToday = (date === todayKey);
                let colorStyle = "";
                if (isToday) {
                    if (row['ìƒíƒœ'] === 'UP') colorStyle = "color:#dc2626; font-weight:bold;";
                    else if (row['ìƒíƒœ'] === 'DOWN') colorStyle = "color:#16a34a; font-weight:bold;";
                    else if (row['ìƒíƒœ'] === 'NEW') colorStyle = "color:#2563eb; font-weight:bold;";
                }
                html += `<td style="text-align:right; ${colorStyle}">${displayVal}</td>`;
            });

            const diff = row['ë³€ë™ì•¡'];
            let diffStr = (diff > 0) ? `+${parseInt(diff).toLocaleString()}` : (diff ? parseInt(diff).toLocaleString() : '-');
            let diffColor = (diff > 0) ? 'color:#dc2626;' : (diff < 0 ? 'color:#16a34a;' : 'color:#999;');

            html += `<td style="text-align:right; font-weight:bold; ${diffColor}">${diffStr}</td><td style="font-size:11px;">${row['ê³„ì•½ì¢…ë£Œì¼']||''}</td>`;
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        document.getElementById("resultArea").classList.remove("hidden");
        document.getElementById("count").innerText = filtered.length;
    }

    function downloadCSV() {
        if (mergedData.length === 0) return;
        const category = document.getElementById('categorySelect').value;
        const today = new Date().toISOString().slice(0,10).replace(/-/g,"");
        const finalCsvData = mergedData.map(row => {
            let item = { 'ìƒíƒœ': row['ìƒíƒœ'], 'ì—…ì²´ëª…': row['ì—…ì²´ëª…'], 'ì‹ë³„ë²ˆí˜¸': row['ì‹ë³„ë²ˆí˜¸'], 'ê·œê²©': row['ê·œê²©'] };
            dateColumns.forEach(d => item[d] = row[d]);
            item['ë³€ë™ì•¡'] = row['ë³€ë™ì•¡'];
            item['ê³„ì•½ì¢…ë£Œì¼'] = row['ê³„ì•½ì¢…ë£Œì¼'];
            return item;
        });
        const csv = Papa.unparse(finalCsvData, { quotes: true });
        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ì¡°ë‹¬ì²­_${category}_ê°€ê²©ëŒ€ì¥_${today}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>

</html>
