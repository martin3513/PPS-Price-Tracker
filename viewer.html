<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPS Price Tracker - ìë™ ë¶„ì„ ë·°ì–´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            padding: 20px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 750px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            position: relative;
            background: white;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            font-size: 13px;
            white-space: nowrap;
            width: 100%;
        }

        th,
        td {
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            padding: 10px 12px;
            vertical-align: middle;
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 30;
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            height: 45px;
            font-weight: bold;
            color: #4b5563;
        }

        /* ê³ ì • ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ */
        th:nth-child(1),
        td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: #f9fafb;
            border-right: 2px solid #e5e7eb;
            text-align: center;
        }

        th:nth-child(2),
        td:nth-child(2) {
            position: sticky;
            left: 60px;
            z-index: 20;
            background-color: #f9fafb;
            border-right: 2px solid #e5e7eb;
        }

        th:nth-child(3),
        td:nth-child(3) {
            position: sticky;
            left: 210px;
            z-index: 20;
            background-color: #f9fafb;
            border-right: 2px solid #dedede;
        }

        thead th:nth-child(1),
        thead th:nth-child(2),
        thead th:nth-child(3) {
            z-index: 40;
            background-color: #e5e7eb;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            border: none;
            font-size: 14px;
            transition: 0.2s;
        }

        .btn-blue {
            background-color: #2563eb;
        }

        .btn-blue:hover {
            background-color: #1d4ed8;
        }

        .btn-green {
            background-color: #16a34a;
        }

        .btn-green:hover {
            opacity: 0.9;
        }

        .btn-indigo {
            background-color: #4f46e5;
        }

        .btn-gray {
            background-color: #6b7280;
        }

        .bg-red-row {
            background-color: #fef2f2 !important;
        }

        .bg-green-row {
            background-color: #f0fdf4 !important;
        }

        /* ìƒíƒœ ë°°ì§€ */
        .status-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-up {
            color: #dc2626;
            background-color: #fee2e2;
        }

        .status-down {
            color: #16a34a;
            background-color: #dcfce7;
        }

        .status-new {
            color: #2563eb;
            background-color: #dbeafe;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* í•„í„° ë°•ìŠ¤ ë° ê·œê²© ìŠ¤íƒ€ì¼ */
        .filter-box {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .spec-cell-compact {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .spec-cell-full {
            max-width: none;
            white-space: normal;
            min-width: 400px;
        }

        /* ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #detailModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 85%;
            overflow: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .modal-body table {
            font-size: 13px;
        }

        .modal-body th {
            background-color: #f9fafb;
            color: #4b5563;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .close-btn {
            cursor: pointer;
            font-size: 24px;
            color: #9ca3af;
            transition: 0.2s;
        }

        .close-btn:hover {
            color: #4b5563;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                    ì¡°ë‹¬ì²­ ê°€ê²© ë³€ë™ ë·°ì–´
                    <span class="text-sm font-normal text-gray-500 bg-gray-200 px-2 py-1 rounded">Live Data</span>
                </h1>
                <p class="text-gray-500 mt-1 text-sm">GitHub ì €ì¥ì†Œì˜ ìµœì‹  ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
            </div>

            <div class="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm border">
                <label for="categorySelect" class="font-bold text-gray-700 px-2">í’ˆëª© ì„ íƒ:</label>
                <select id="categorySelect"
                    class="p-2 border rounded-md min-w-[200px] text-gray-700 font-medium outline-none focus:ring-2 focus:ring-blue-500"
                    onchange="loadData()">
                    <option value="ë…¸íŠ¸ë¶">ë…¸íŠ¸ë¶</option>
                    <option value="ë°ìŠ¤í¬í†±ì»´í“¨í„°">ë°ìŠ¤í¬í†±ì»´í“¨í„°</option>
                    <option value="ëª¨ë‹ˆí„°">ëª¨ë‹ˆí„°</option>
                    <option value="ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ">ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ</option>
                </select>
                <button onclick="loadData()" class="btn btn-blue ml-2">ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

        <!-- ìƒíƒœ ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="statusArea"
            class="hidden mb-4 p-4 rounded-lg bg-blue-50 border border-blue-100 flex items-center justify-center gap-3">
            <div id="spinner" class="loading-spinner hidden"></div>
            <span id="statusText" class="text-blue-700 font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
        </div>

        <!-- ê²°ê³¼ í…Œì´ë¸” ì˜ì—­ -->
        <div id="resultArea" class="hidden animate-fade-in">
            <div class="flex justify-between items-end mb-2 px-1">
                <div>
                    <h2 class="text-xl font-bold text-gray-700 mb-1">ë¶„ì„ ê²°ê³¼ (<span id="count">0</span>ê±´)</h2>
                    <div class="text-xs text-gray-500">* ìµœê·¼ ë‚ ì§œ ê¸°ì¤€ ê°€ê²© ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ë¨</div>
                </div>
                <button onclick="downloadCSV()" class="btn btn-green">ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <!-- í•„í„° ë°•ìŠ¤ ì¶”ê°€ -->
            <div class="filter-box">
                <div>
                    <label class="font-bold text-gray-700 mr-2">ì—…ì²´ëª…:</label>
                    <select id="companyFilter" onchange="renderTable()" class="p-1 border rounded"
                        style="width: 150px;">
                        <option value="">ì „ì²´ ì—…ì²´</option>
                    </select>
                </div>
                <div>
                    <label class="font-bold text-gray-700 mr-2">ìƒíƒœ:</label>
                    <select id="statusFilter" onchange="renderTable()" class="p-1 border rounded" style="width: 120px;">
                        <option value="">ì „ì²´ ë³´ê¸°</option>
                        <option value="UP">ì¸ìƒ (ğŸ”º)</option>
                        <option value="DOWN">ì¸í•˜ (ğŸ”»)</option>
                        <option value="NEW">ì‹ ê·œ</option>
                        <option value="SAME">ë³€ë™ì—†ìŒ</option>
                    </select>
                </div>

                <button onclick="toggleSpecView()" class="btn btn-indigo" id="specToggleBtn">â†” ê·œê²© ì „ì²´ë³´ê¸°</button>
            </div>

            <div class="table-wrapper">
                <table id="resultTable" class="w-full">
                    <thead>
                        <!-- í—¤ë”ëŠ” JSë¡œ ë™ì  ìƒì„± -->
                    </thead>
                    <tbody>
                        <!-- ë°ì´í„°ëŠ” JSë¡œ ë™ì  ìƒì„± -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-800">ìƒì„¸ ê·œê²© ì •ë³´</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" class="modal-body">
                <!-- ì—¬ê¸°ì— ì—‘ì…€ ë°ì´í„° í…Œì´ë¸”ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
                <div class="flex items-center justify-center p-10">
                    <div class="loading-spinner"></div>
                    <span class="ml-3 text-gray-600">ë°ì´í„°ë¥¼ ì°¾ëŠ” ì¤‘...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const REPO_OWNER = "martin3513";
        const REPO_NAME = "PPS-Price-Tracker";
        const DATA_DIR = "data";

        let globalData = [];    // ì „ì²´ ë°ì´í„° ì €ì¥ìš©
        let globalHeaders = []; // í—¤ë” ì •ë³´ ì €ì¥ìš©
        let isSpecExpanded = false; // ê·œê²© í¼ì¹¨ ì—¬ë¶€

        // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadData() {
            const category = document.getElementById('categorySelect').value;
            showStatus(true, `ìµœì‹  ë°ì´í„°ë¥¼ ì°¾ëŠ” ì¤‘... (${category})`);
            document.getElementById('resultArea').classList.add('hidden');

            // ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì‹œ ê²½ê³  (ë‹¨, ê³„ì† ì§„í–‰ì€ ì‹œë„)
            if (window.location.protocol === 'file:') {
                console.warn("ë¡œì»¬ íŒŒì¼(file://) í™˜ê²½ì—ì„œëŠ” GitHub API í˜¸ì¶œì´ ì°¨ë‹¨ë˜ê±°ë‚˜ CORS ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }

            try {
                // 1. GitHub APIë¡œ data í´ë” ëª©ë¡ ì¡°íšŒ
                const cleanApiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${DATA_DIR}`;

                const listResponse = await fetch(cleanApiUrl);

                if (!listResponse.ok) {
                    if (listResponse.status === 404) {
                        throw new Error(`ì €ì¥ì†Œì— 'data' í´ë”ê°€ ì—†ê±°ë‚˜, ì•„ì§ íŒŒì¼ì´ ì—…ë¡œë“œ(Push)ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n(GitHubì— íŒŒì¼ì„ ì˜¬ë¦¬ì…¨ë‚˜ìš”?)`);
                    }
                    const errJson = await listResponse.json();
                    throw new Error(`íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (${listResponse.status}): ${errJson.message || listResponse.statusText}`);
                }

                const files = await listResponse.json();

                // 2. íŒŒì¼ í•„í„°ë§: "ì¡°ë‹¬ì²­_{ì¹´í…Œê³ ë¦¬}_ê°€ê²©ëŒ€ì¥_" ìœ¼ë¡œ ì‹œì‘í•˜ê³  ".csv"ë¡œ ëë‚˜ëŠ” íŒŒì¼
                const prefix = `ì¡°ë‹¬ì²­_${category}_ê°€ê²©ëŒ€ì¥_`;

                const matchedFiles = files.filter(file => {
                    return file.name.startsWith(prefix) && file.name.endsWith(".csv");
                });

                if (matchedFiles.length === 0) {
                    throw new Error(`'${category}' ê´€ë ¨ íŒŒì¼ì„ GitHubì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ëª… ì˜ˆì‹œ: ${prefix}20250103.csv`);
                }

                // 3. ìµœì‹  ë‚ ì§œìˆœ ì •ë ¬ (íŒŒì¼ëª…ì— í¬í•¨ëœ ë‚ ì§œ ìˆ«ì ì¶”ì¶œí•˜ì—¬ ë¹„êµ)
                // ì˜ˆ: ì¡°ë‹¬ì²­_ë…¸íŠ¸ë¶_ê°€ê²©ëŒ€ì¥_20250103.csv -> 20250103
                matchedFiles.sort((a, b) => {
                    const getDate = (name) => {
                        const match = name.match(/(\d{8})/); // 8ìë¦¬ ì—°ì† ìˆ«ì ì¶”ì¶œ
                        return match ? parseInt(match[1]) : 0;
                    };
                    return getDate(b.name) - getDate(a.name); // ë‚´ë¦¼ì°¨ìˆœ (í° ìˆ«ìê°€ ë¨¼ì €)
                });

                const latestFile = matchedFiles[0];
                const downloadUrl = latestFile.download_url;

                console.log("Loading latest file:", latestFile.name);
                showStatus(true, `ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘... (${latestFile.name})`);

                // 4. CSV ë‹¤ìš´ë¡œë“œ
                const csvResponse = await fetch(downloadUrl);
                if (!csvResponse.ok) throw new Error("CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");

                const csvText = await csvResponse.text();
                parseAndRender(csvText);

            } catch (error) {
                let msg = error.message;
                if (window.location.protocol === 'file:' && !msg.includes("Push")) {
                    msg += `\n\n(GitHub Pagesë¥¼ ì´ìš©í•˜ê±°ë‚˜ ë¡œì»¬ ì„œë²„ë¥¼ ë„ì›Œì£¼ì„¸ìš”.)`;
                }
                showStatus(false, `ì˜¤ë¥˜ ë°œìƒ: ${msg}`, true);
            }
        }

        function showStatus(isLoading, message, isError = false) {
            const area = document.getElementById('statusArea');
            const spinner = document.getElementById('spinner');
            const text = document.getElementById('statusText');

            area.classList.remove('hidden');
            text.innerText = message;

            if (isLoading) {
                spinner.classList.remove('hidden');
                area.className = "mb-4 p-4 rounded-lg bg-blue-50 border border-blue-100 flex items-center justify-center gap-3";
                text.className = "text-blue-700 font-bold";
            } else {
                spinner.classList.add('hidden');
                if (isError) {
                    area.className = "mb-4 p-4 rounded-lg bg-red-50 border border-red-100 flex items-center justify-center gap-3";
                    text.className = "text-red-700 font-bold";
                } else {
                    area.classList.add('hidden'); // ì„±ê³µ ì‹œ ìˆ¨ê¹€
                }
            }
        }

        function parseAndRender(csvText) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    if (!results.data || results.data.length === 0) {
                        showStatus(false, "ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.", true);
                        return;
                    }

                    showStatus(false, "ì™„ë£Œ"); // ë¡œë”© ìˆ¨ê¹€

                    // ì „ì—­ ë°ì´í„° ì €ì¥
                    globalData = results.data;
                    globalHeaders = results.meta.fields;

                    updateFilters(); // ì—…ì²´ëª… í•„í„° ì±„ìš°ê¸°
                    renderTable();   // í…Œì´ë¸” ê·¸ë¦¬ê¸°
                },
                error: function (err) {
                    showStatus(false, `CSV íŒŒì‹± ì˜¤ë¥˜: ${err.message}`, true);
                }
            });
        }

        // ì—…ì²´ëª… ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateFilters() {
            const companySet = new Set();
            globalData.forEach(row => {
                if (row['ì—…ì²´ëª…']) companySet.add(row['ì—…ì²´ëª…']);
            });
            const sortedComp = Array.from(companySet).sort();

            const sel = document.getElementById("companyFilter");
            const currentVal = sel.value; // ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€ ì‹œë„
            sel.innerHTML = '<option value="">ì „ì²´ ì—…ì²´</option>';

            sortedComp.forEach(c => {
                const op = document.createElement("option");
                op.value = c;
                op.innerText = c;
                sel.appendChild(op);
            });

            if (sortedComp.includes(currentVal)) {
                sel.value = currentVal;
            }
        }

        function toggleSpecView() {
            isSpecExpanded = !isSpecExpanded;
            const btn = document.getElementById('specToggleBtn');
            if (isSpecExpanded) {
                btn.innerText = ">< ê·œê²© ì¢ê²Œë³´ê¸°";
                btn.classList.replace('btn-indigo', 'btn-gray');
            } else {
                btn.innerText = "â†” ê·œê²© ì „ì²´ë³´ê¸°";
                btn.classList.replace('btn-gray', 'btn-indigo');
            }
            renderTable();
        }

        function renderTable() {
            const companyVal = document.getElementById("companyFilter").value;
            const statusVal = document.getElementById("statusFilter").value;

            const tableHead = document.querySelector("#resultTable thead");
            const tableBody = document.querySelector("#resultTable tbody");

            // ì»¬ëŸ¼ ë¶„ë¥˜
            const fixedCols = ['ìƒíƒœ', 'ì—…ì²´ëª…', 'ì‹ë³„ë²ˆí˜¸', 'ê·œê²©', 'ê³„ì•½ì¢…ë£Œì¼', 'ë³€ë™ì•¡', 'ë¹„ê³ '];
            // ë‚ ì§œ ì»¬ëŸ¼ ì •ë ¬: ë¬¸ìì—´ ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ (ê³¼ê±° -> ìµœì‹ )
            // 2025-12-17, 2025-12-24, 2025-12-25 ìˆœì„œ
            const dateCols = globalHeaders.filter(h => !fixedCols.includes(h)).sort();

            // í•„í„°ë§
            let filtered = globalData.filter(row => {
                const matchComp = (companyVal === "") || (row['ì—…ì²´ëª…'] === companyVal);
                const matchStat = (statusVal === "") || (row['ìƒíƒœ'] === statusVal);
                return matchComp && matchStat;
            });


            // ì •ë ¬: *ìµœê·¼* ë‚ ì§œ ê°€ê²© ì˜¤ë¦„ì°¨ìˆœ
            // dateColsê°€ ì˜¤ë¦„ì°¨ìˆœ(ê³¼ê±°->ìµœì‹ )ì´ë¯€ë¡œ, ë§¨ ë’¤(length-1)ê°€ ìµœì‹  ë‚ ì§œ
            const latestDate = dateCols[dateCols.length - 1];
            filtered.sort((a, b) => {
                const priceA = parseInt((a[latestDate] || "0").replace(/,/g, ''));
                const priceB = parseInt((b[latestDate] || "0").replace(/,/g, ''));
                if (priceA !== priceB) return priceA - priceB;
                return a['ì—…ì²´ëª…'].localeCompare(b['ì—…ì²´ëª…']);
            });

            document.getElementById('count').innerText = filtered.length;

            // 1. í—¤ë” ìƒì„±
            let thHTML = `<tr>
            <th class="w-[60px]">ìƒíƒœ</th>
            <th class="w-[150px]">ì—…ì²´ëª…</th>
            <th class="w-[100px]">ì‹ë³„ë²ˆí˜¸</th>
            <th class="w-[300px]">ê·œê²©</th>`;

            dateCols.forEach((date, idx) => {
                // ìµœì‹  ë‚ ì§œì¸ì§€ í™•ì¸ (ë§ˆì§€ë§‰ ì»¬ëŸ¼)
                const isLatest = (idx === dateCols.length - 1);
                const style = isLatest ? 'background-color:#dbeafe; color:#1e40af; border-bottom:2px solid #2563eb;' : '';
                thHTML += `<th style="text-align:right; min-width:90px; ${style}">${date}</th>`;
            });

            thHTML += `<th style="text-align:right;">ë³€ë™ì•¡</th><th>ì¢…ë£Œì¼</th></tr>`;
            tableHead.innerHTML = thHTML;

            // 2. ë°”ë”” ìƒì„±
            let tbodyHTML = "";
            const specClass = isSpecExpanded ? 'spec-cell-full' : 'spec-cell-compact';

            filtered.forEach(row => {
                const status = row['ìƒíƒœ'];
                let rowClass = "";
                let statusHTML = `<span class="text-gray-400">-</span>`;

                if (status === 'UP') {
                    rowClass = "bg-red-row";
                    statusHTML = `<span class="status-badge status-up">ì¸ìƒ ğŸ”º</span>`;
                } else if (status === 'DOWN') {
                    rowClass = "bg-green-row";
                    statusHTML = `<span class="status-badge status-down">ì¸í•˜ ğŸ”»</span>`;
                } else if (status === 'NEW') {
                    statusHTML = `<span class="status-badge status-new">ì‹ ê·œ</span>`;
                }

                tbodyHTML += `<tr class="${rowClass}">
                <td style="text-align:center;">${statusHTML}</td>
                <td class="font-bold text-gray-700">${row['ì—…ì²´ëª…'] || ''}</td>
                <td style="text-align:center;">
                    <div class="cursor-pointer text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1 group" 
                         onclick="copyAndOpenG2B('${row['ì‹ë³„ë²ˆí˜¸']}')" 
                         title="í´ë¦­ ì‹œ ì‹ë³„ë²ˆí˜¸ ë³µì‚¬ í›„ ë‚˜ë¼ì¥í„° ì‡¼í•‘ëª° ì´ë™">
                         <span>${row['ì‹ë³„ë²ˆí˜¸']}</span>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 00-2 2h10a2 2 0 00-2-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </div>
                </td>
                <td class="${specClass} ${row['ì‹ë³„ë²ˆí˜¸'] && document.getElementById('categorySelect').value === 'ë°ìŠ¤í¬í†±ì»´í“¨í„°' ? 'cursor-pointer hover:bg-yellow-50 hover:text-blue-700' : ''}" 
                    title="${row['ê·œê²©'] || ''} ${document.getElementById('categorySelect').value === 'ë°ìŠ¤í¬í†±ì»´í“¨í„°' ? '(í´ë¦­ ì‹œ ìƒì„¸ì •ë³´ ë³´ê¸°)' : ''}" 
                    style="font-size:12px; color:#555;"
                    onclick="${document.getElementById('categorySelect').value === 'ë°ìŠ¤í¬í†±ì»´í“¨í„°' ? `showDesktopDetails('${row['ì‹ë³„ë²ˆí˜¸']}')` : ''}">
                    ${row['ê·œê²©'] || ''}
                </td>`;

                dateCols.forEach((date, idx) => {
                    const val = row[date];
                    const displayVal = val ? parseInt(val.replace(/,/g, '')).toLocaleString() : '-';
                    const isLatest = (idx === dateCols.length - 1);
                    let style = "text-align:right;";
                    if (isLatest) style += "font-weight:bold; color:#111827;";

                    tbodyHTML += `<td style="${style}">${displayVal}</td>`;
                });

                const diff = row['ë³€ë™ì•¡'];
                let diffStr = (diff && diff !== "0") ? parseInt(diff).toLocaleString() : '-';
                let diffStyle = "text-align:right; color:#9ca3af;";
                if (parseInt(diff) > 0) {
                    diffStr = "+" + diffStr;
                    diffStyle = "text-align:right; color:#dc2626; font-weight:bold;";
                } else if (parseInt(diff) < 0) {
                    diffStyle = "text-align:right; color:#16a34a; font-weight:bold;";
                }

                tbodyHTML += `<td style="${diffStyle}">${diffStr}</td>
                          <td style="font-size:12px;">${row['ê³„ì•½ì¢…ë£Œì¼'] || ''}</td>
                          </tr>`;
            });

            tableBody.innerHTML = tbodyHTML;
            document.getElementById('resultArea').classList.remove('hidden');
        }

        async function copyAndOpenG2B(id) {
            try {
                await navigator.clipboard.writeText(id);
                // alert(`ì‹ë³„ë²ˆí˜¸(${id})ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nê²€ìƒ‰ì°½ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”.`);
                window.open("http://shop.g2b.go.kr/", "_blank");
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                window.open("http://shop.g2b.go.kr/", "_blank");
            }
        }

        // ë°ìŠ¤í¬í†± ìƒì„¸ ì •ë³´ ë³´ê¸° ê´€ë ¨ ë³€ìˆ˜
        let desktopWorkbook = null;

        async function showDesktopDetails(id) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');

            modal.style.display = 'flex';
            modalTitle.innerText = `ìƒì„¸ ê·œê²© ì •ë³´ (ì‹ë³„ë²ˆí˜¸: ${id})`;
            modalBody.innerHTML = `
                <div class="flex items-center justify-center p-10">
                    <div class="loading-spinner"></div>
                    <span class="ml-3 text-gray-600">ë°ì´í„°ë¥¼ ì°¾ëŠ” ì¤‘...</span>
                </div>`;

            try {
                // 1. ì—‘ì…€ íŒŒì¼ ë¡œë“œ (ìµœì´ˆ 1íšŒë§Œ)
                if (!desktopWorkbook) {
                    const excelUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/desktop_db.xlsx`;

                    try {
                        const response = await fetch(excelUrl);
                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error("GitHub ì €ì¥ì†Œì— 'data/desktop_db.xlsx' íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (Pushë¥¼ í•˜ì…¨ë‚˜ìš”?)");
                            }
                            throw new Error(`ì—‘ì…€ íŒŒì¼ ì‘ë‹µ ì˜¤ë¥˜ (Status: ${response.status})`);
                        }
                        const arrayBuffer = await response.arrayBuffer();
                        desktopWorkbook = XLSX.read(arrayBuffer, { type: 'array' });
                    } catch (err) {
                        throw new Error(`ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${err.message}\n(ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” CORS ì •ì±…ìœ¼ë¡œ ë¡œë“œê°€ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)`);
                    }
                }

                // 2. ëª¨ë“  ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê²€ìƒ‰ ì‹œë„
                let foundData = null;
                let foundSheetName = "";
                let foundHeader1 = [];
                let foundHeader2 = [];

                for (const sheetName of desktopWorkbook.SheetNames) {
                    const sheet = desktopWorkbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (data.length < 5) continue;

                    // 2.1 "ë¬¼í’ˆ ì‹ë³„ë²ˆí˜¸" ì»¬ëŸ¼ ë™ì  ì°¾ê¸° (ìƒë‹¨ 150í–‰ ì´ë‚´)
                    let idColIndex = -1;
                    let h2Idx = -1;
                    for (let r = 0; r < Math.min(data.length, 150); r++) {
                        const row = data[r] || [];
                        const foundIdx = row.findIndex(h => String(h || "").replace(/\s/g, "").includes("ë¬¼í’ˆì‹ë³„ë²ˆí˜¸"));
                        if (foundIdx !== -1) {
                            idColIndex = foundIdx;
                            h2Idx = r;
                            break;
                        }
                    }

                    if (idColIndex !== -1) {
                        const searchId = String(id).trim().replace(/,/g, "");
                        const targetRow = data.find(row => {
                            const cellValue = String(row[idColIndex] || "").trim().replace(/,/g, "");
                            return cellValue === searchId;
                        });

                        if (targetRow) {
                            foundData = targetRow;
                            foundSheetName = sheetName;

                            // 2.2 ë¶€ëª¨ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ì¶œ (ë‹¤ì¤‘ í–‰ ìŠ¤ìº” + ì‚¬ìš©ì ìš”ì²­ Forward-fill)
                            const categoryMap = new Array(foundHeader2.length).fill("");

                            // í—¤ë”(h2Idx) ìœ„ì˜ ëª¨ë“  í–‰ì„ ëŒ€ìƒìœ¼ë¡œ ìœ íš¨í•œ ì¹´í…Œê³ ë¦¬ëª… ì¶”ì¶œ
                            for (let r = 0; r < h2Idx; r++) {
                                const currentRow = data[r] || [];
                                let currentRowValue = "";
                                for (let c = 0; c < foundHeader2.length; c++) {
                                    const cellValue = String(currentRow[c] || "").trim();
                                    if (cellValue !== "") {
                                        currentRowValue = cellValue;
                                    }
                                    if (currentRowValue !== "" && !["", "ê·œê²©", "ê·œê²©ëª…", "ë¬¼í’ˆëª…", "ì‹ë³„ë²ˆí˜¸"].some(k => currentRowValue.includes(k))) {
                                        categoryMap[c] = currentRowValue;
                                    }
                                }
                            }

                            foundHeader1 = categoryMap; // í™•ì •ëœ ë‹¤ì¤‘í–‰ ì¹´í…Œê³ ë¦¬ ë§µ ì‚¬ìš©
                            foundHeader2 = data[h2Idx] || [];
                            break;
                        }
                    }
                }

                if (!foundData) {
                    throw new Error("ìë£Œ ì—†ìŒ");
                }

                // 3. í…Œì´ë¸” ìƒì„± (ì„¸ë¡œí˜•)
                let tableHTML = `<table class="min-w-full border-collapse border border-gray-200 shadow-sm rounded-lg overflow-hidden">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border border-gray-300 p-2.5 w-1/3 text-xs font-bold text-gray-600 tracking-wider">í•­ëª© (êµ¬ë¶„)</th>
                            <th class="border border-gray-300 p-2.5 text-xs font-bold text-gray-600 tracking-wider">ìƒì„¸ ì‚¬ì–‘</th>
                        </tr>
                    </thead>
                    <tbody>`;

                let lastDisplayedParent = "";
                foundHeader2.forEach((h, idx) => {
                    if (!h) return;

                    const headerText = String(h).trim();
                    // "ì‹ë³„ë²ˆí˜¸"ê°€ í¬í•¨ëœ í–‰ì€ ì‚¬ì–‘í‘œì—ì„œ ìˆ¨ê¹€
                    if (headerText.includes("ì‹ë³„ë²ˆí˜¸")) return;
                    const val = foundData[idx] || '-';
                    const parent = foundHeader1[idx] || '';

                    // ì œëª© í…ìŠ¤íŠ¸ì— ë¶€ëª¨ ì¹´í…Œê³ ë¦¬ ì ‘ë‘ì–´ ì¶”ê°€ (ì‚¬ìš©ì ìš”ì²­: [CPU] ê·œê²©ëª… ë“±)
                    const displayHeaderText = parent ? `[${parent}] ${headerText}` : headerText;

                    // ì¹´í…Œê³ ë¦¬ êµ¬ë¶„ í–‰ (ì „ë¬¸ê°€ ìŠ¤íƒ€ì¼: ì†Œí”„íŠ¸ ë¸”ë£¨ ë°°ê²½ + êµµì€ ì¤‘ì•™ ì •ë ¬)
                    if (parent && parent !== lastDisplayedParent) {
                        tableHTML += `
                            <tr class="bg-blue-50/70">
                                <td colspan="2" class="p-2.5 text-center border border-gray-200">
                                    <span class="text-blue-800 font-extrabold text-[13px] tracking-tight whitespace-nowrap">
                                        [ ${parent} ]
                                    </span>
                                </td>
                            </tr>`;
                        lastDisplayedParent = parent;
                    }

                    tableHTML += `
                        <tr class="hover:bg-gray-50/80 transition-colors">
                            <td class="border border-gray-300 p-2.5 bg-gray-50/50 font-bold text-gray-700 text-[12px]">
                                ${displayHeaderText}
                            </td>
                            <td class="border border-gray-300 p-2.5 text-gray-800 text-[13px] leading-relaxed">
                                ${val}
                            </td>
                        </tr>`;
                });

                tableHTML += `</tbody></table>`;
                modalBody.innerHTML = tableHTML;

            } catch (error) {
                modalBody.innerHTML = `
                    <div class="p-8 text-center text-red-600 font-bold">
                        ì˜¤ë¥˜: ${error.message}
                    </div>`;
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function (event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        function downloadCSV() {
            if (globalData.length === 0) return;
            const category = document.getElementById('categorySelect').value;
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, "");

            // í‘œì‹œëœ ë°ì´í„°ë§Œ ë‹¤ìš´ë¡œë“œí• ì§€, ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí• ì§€ ê²°ì •
            // ì—¬ê¸°ì„œëŠ” ë³´ì´ëŠ” ëŒ€ë¡œ(í•„í„°ë§ëœ) ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜, ì›ë³¸ ì „ì²´ë¥¼ ë°›ì„ ìˆ˜ ìˆìŒ.
            // ë³´í†µ 'ë¶„ì„ ê²°ê³¼' ë‹¤ìš´ë¡œë“œëŠ” í˜„ì¬ ë³´ê³  ìˆëŠ” ì „ì²´ ë°ì´í„°ë¥¼ ì˜ë¯¸í•¨ (í•„í„°ë§ ìƒê´€ì—†ì´ or í•„í„°ë§ ì ìš©í•´ì„œ)
            // ê¸°ì¡´ index.html ë¡œì§ì€ mergedData(ì „ì²´)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œë„ globalData(ì „ì²´)ë¥¼ CSVë¡œ ë³€í™˜
            // ë‹¨, í™”ë©´ì— í•„í„°ë§ëœ ê²ƒë§Œ ë°›ê³  ì‹¶ë‹¤ë©´ filtered ë°ì´í„°ë¥¼ ì¨ì•¼í•¨.
            // -> ìš°ì„  ì „ì²´ ë°ì´í„° ì €ì¥ì„ ê¸°ë³¸ìœ¼ë¡œ í•¨.

            const csv = Papa.unparse(globalData, {
                quotes: true
            });
            const blob = new Blob(["\uFEFF" + csv], {
                type: "text/csv;charset=utf-8;"
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            // íŒŒì¼ëª…ì— 'download' ì ‘ë¯¸ì‚¬ ì¶”ê°€í•˜ì—¬ êµ¬ë¶„
            link.download = `ì¡°ë‹¬ì²­_${category}_ê°€ê²©ëŒ€ì¥_DOWNLOAD.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // window.onload = loadData; // ìë™ ì‹¤í–‰ ì›í•˜ë©´ ì£¼ì„ í•´ì œ
        loadData();
    </script>

</body>

</html>