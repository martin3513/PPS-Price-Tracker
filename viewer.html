<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPS Price Tracker - ìë™ ë¶„ì„ ë·°ì–´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 98%; margin: 0 auto; padding: 20px; }
        
        .table-wrapper { 
            overflow-x: auto; 
            max-height: 750px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            border-radius: 8px; 
            border: 1px solid #e5e7eb;
            position: relative;
            background: white;
        }
        
        table { border-collapse: separate; border-spacing: 0; background: white; font-size: 13px; white-space: nowrap; width: 100%; }
        th, td { border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; padding: 10px 12px; vertical-align: middle; }
        
        thead th { position: sticky; top: 0; z-index: 30; background-color: #f3f4f6; border-top: 1px solid #e5e7eb; height: 45px; font-weight: bold; color: #4b5563; }
        
        /* ê³ ì • ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ */
        th:nth-child(1), td:nth-child(1) { position: sticky; left: 0; z-index: 20; background-color: #f9fafb; border-right: 2px solid #e5e7eb; text-align: center;}
        th:nth-child(2), td:nth-child(2) { position: sticky; left: 60px; z-index: 20; background-color: #f9fafb; border-right: 2px solid #e5e7eb; }
        th:nth-child(3), td:nth-child(3) { position: sticky; left: 210px; z-index: 20; background-color: #f9fafb; border-right: 2px solid #dedede; }
        
        thead th:nth-child(1), thead th:nth-child(2), thead th:nth-child(3) { z-index: 40; background-color: #e5e7eb; }

        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; border: none; font-size: 14px; transition: 0.2s; }
        .btn-blue { background-color: #2563eb; }
        .btn-blue:hover { background-color: #1d4ed8; }

        .bg-red-row { background-color: #fef2f2 !important; }
        .bg-green-row { background-color: #f0fdf4 !important; }
        
        /* ìƒíƒœ ë°°ì§€ */
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-up { color: #dc2626; background-color: #fee2e2; }
        .status-down { color: #16a34a; background-color: #dcfce7; }
        .status-new { color: #2563eb; background-color: #dbeafe; }

        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                ğŸ“Š ì¡°ë‹¬ì²­ ê°€ê²© ë³€ë™ ë·°ì–´
                <span class="text-sm font-normal text-gray-500 bg-gray-200 px-2 py-1 rounded">Live Data</span>
            </h1>
            <p class="text-gray-500 mt-1 text-sm">GitHub ì €ì¥ì†Œì˜ ìµœì‹  ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
        </div>

        <div class="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm border">
            <label for="categorySelect" class="font-bold text-gray-700 px-2">ğŸ“ í’ˆëª© ì„ íƒ:</label>
            <select id="categorySelect" class="p-2 border rounded-md min-w-[200px] text-gray-700 font-medium outline-none focus:ring-2 focus:ring-blue-500" onchange="loadData()">
                <option value="notebook">ë…¸íŠ¸ë¶ (notebook.csv)</option>
                <option value="desktop">ë°ìŠ¤í¬í†±ì»´í“¨í„° (desktop.csv)</option>
                <option value="monitor">ëª¨ë‹ˆí„° (monitor.csv)</option>
                <option value="interactive">ì¸í„°ë™í‹°ë¸Œí™”ì´íŠ¸ë³´ë“œ (interactive.csv)</option>
            </select>
            <button onclick="loadData()" class="btn btn-blue ml-2">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <!-- ìƒíƒœ ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="statusArea" class="hidden mb-4 p-4 rounded-lg bg-blue-50 border border-blue-100 flex items-center justify-center gap-3">
        <div id="spinner" class="loading-spinner hidden"></div>
        <span id="statusText" class="text-blue-700 font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
    </div>

    <!-- ê²°ê³¼ í…Œì´ë¸” ì˜ì—­ -->
    <div id="resultArea" class="hidden animate-fade-in">
        <div class="flex justify-between items-center mb-2 px-1">
            <h2 class="text-xl font-bold text-gray-700">ğŸ“‹ ë¶„ì„ ê²°ê³¼ (<span id="count">0</span>ê±´)</h2>
            <div class="text-xs text-gray-500">
                * ìµœê·¼ ë‚ ì§œ ê¸°ì¤€ ê°€ê²© ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ë¨
            </div>
        </div>
        
        <div class="table-wrapper">
            <table id="resultTable" class="w-full">
                <thead>
                    <!-- í—¤ë”ëŠ” JSë¡œ ë™ì  ìƒì„± -->
                </thead>
                <tbody>
                    <!-- ë°ì´í„°ëŠ” JSë¡œ ë™ì  ìƒì„± -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const REPO_OWNER = "martin3513";
    const REPO_NAME = "PPS-Price-Tracker";
    const BRANCH = "main";
    
    // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadData() {
        const category = document.getElementById('categorySelect').value;
        const fileName = `${category}.csv`;
        // GitHub Raw Data URL êµ¬ì¡°
        const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/${fileName}`;

        showStatus(true, `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (${fileName})`);
        document.getElementById('resultArea').classList.add('hidden');

        try {
            const response = await fetch(url);
            
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(data/${fileName} íŒŒì¼ì´ ì €ì¥ì†Œì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”)`);
                }
                throw new Error(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (Status: ${response.status})`);
            }

            const csvText = await response.text();
            parseAndRender(csvText);

        } catch (error) {
            showStatus(false, `âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
        }
    }

    function showStatus(isLoading, message, isError = false) {
        const area = document.getElementById('statusArea');
        const spinner = document.getElementById('spinner');
        const text = document.getElementById('statusText');

        area.classList.remove('hidden');
        text.innerText = message;
        
        if (isLoading) {
            spinner.classList.remove('hidden');
            area.className = "mb-4 p-4 rounded-lg bg-blue-50 border border-blue-100 flex items-center justify-center gap-3";
            text.className = "text-blue-700 font-bold";
        } else {
            spinner.classList.add('hidden');
            if (isError) {
                area.className = "mb-4 p-4 rounded-lg bg-red-50 border border-red-100 flex items-center justify-center gap-3";
                text.className = "text-red-700 font-bold";
            } else {
                area.classList.add('hidden'); // ì„±ê³µ ì‹œ ìˆ¨ê¹€
            }
        }
    }

    function parseAndRender(csvText) {
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (!results.data || results.data.length === 0) {
                    showStatus(false, "ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.", true);
                    return;
                }
                
                showStatus(false, "ì™„ë£Œ"); // ë¡œë”© ìˆ¨ê¹€
                renderTable(results.data, results.meta.fields);
            },
            error: function(err) {
                showStatus(false, `CSV íŒŒì‹± ì˜¤ë¥˜: ${err.message}`, true);
            }
        });
    }

    function renderTable(data, headers) {
        const tableHead = document.querySelector("#resultTable thead");
        const tableBody = document.querySelector("#resultTable tbody");
        
        // ì»¬ëŸ¼ ë¶„ë¥˜
        const fixedCols = ['ìƒíƒœ', 'ì—…ì²´ëª…', 'ì‹ë³„ë²ˆí˜¸', 'ê·œê²©', 'ê³„ì•½ì¢…ë£Œì¼', 'ë³€ë™ì•¡', 'ë¹„ê³ '];
        const dateCols = headers.filter(h => !fixedCols.includes(h)).sort().reverse(); // ìµœì‹  ë‚ ì§œê°€ ë§¨ ì•ìœ¼ë¡œ ì˜¤ê²Œ ì—­ìˆœ ì •ë ¬
        
        // ì •ë ¬: ìµœì‹  ë‚ ì§œ ê°€ê²© ì˜¤ë¦„ì°¨ìˆœ
        const latestDate = dateCols[0];
        data.sort((a, b) => {
            const priceA = parseInt((a[latestDate] || "0").replace(/,/g, ''));
            const priceB = parseInt((b[latestDate] || "0").replace(/,/g, ''));
            if (priceA !== priceB) return priceA - priceB;
            return a['ì—…ì²´ëª…'].localeCompare(b['ì—…ì²´ëª…']);
        });

        // 1. í—¤ë” ìƒì„±
        let thHTML = `<tr>
            <th class="w-[60px]">ìƒíƒœ</th>
            <th class="w-[150px]">ì—…ì²´ëª…</th>
            <th class="w-[100px]">ì‹ë³„ë²ˆí˜¸</th>
            <th class="w-[300px]">ê·œê²©</th>`;
        
        dateCols.forEach((date, idx) => {
            const isLatest = idx === 0;
            const style = isLatest ? 'background-color:#dbeafe; color:#1e40af; border-bottom:2px solid #2563eb;' : '';
            thHTML += `<th style="text-align:right; min-width:90px; ${style}">${date}</th>`;
        });
        
        thHTML += `<th style="text-align:right;">ë³€ë™ì•¡</th><th>ì¢…ë£Œì¼</th></tr>`;
        tableHead.innerHTML = thHTML;

        // 2. ë°”ë”” ìƒì„±
        let tbodyHTML = "";
        data.forEach(row => {
            const status = row['ìƒíƒœ'];
            let rowClass = "";
            let statusHTML = `<span class="text-gray-400">-</span>`;

            if (status === 'UP') {
                rowClass = "bg-red-row";
                statusHTML = `<span class="status-badge status-up">ì¸ìƒ ğŸ”º</span>`;
            } else if (status === 'DOWN') {
                rowClass = "bg-green-row";
                statusHTML = `<span class="status-badge status-down">ì¸í•˜ ğŸ”»</span>`;
            } else if (status === 'NEW') {
                statusHTML = `<span class="status-badge status-new">ì‹ ê·œ ğŸ†•</span>`;
            }

            tbodyHTML += `<tr class="${rowClass}">
                <td style="text-align:center;">${statusHTML}</td>
                <td class="font-bold text-gray-700">${row['ì—…ì²´ëª…'] || ''}</td>
                <td>${row['ì‹ë³„ë²ˆí˜¸'] || ''}</td>
                <td title="${row['ê·œê²©'] || ''}" style="max-width:300px; overflow:hidden; text-overflow:ellipsis; font-size:12px; color:#555;">
                    ${row['ê·œê²©'] || ''}
                </td>`;
            
            dateCols.forEach((date, idx) => {
                const val = row[date];
                const displayVal = val ? parseInt(val.replace(/,/g, '')).toLocaleString() : '-';
                const isLatest = idx === 0;
                let style = "text-align:right;";
                if (isLatest) style += "font-weight:bold; color:#111827;";
                
                tbodyHTML += `<td style="${style}">${displayVal}</td>`;
            });

            const diff = row['ë³€ë™ì•¡'];
            let diffStr = (diff && diff !== "0") ? parseInt(diff).toLocaleString() : '-';
            let diffStyle = "text-align:right; color:#9ca3af;";
            if (parseInt(diff) > 0) { diffStr = "+" + diffStr; diffStyle = "text-align:right; color:#dc2626; font-weight:bold;"; }
            else if (parseInt(diff) < 0) { diffStyle = "text-align:right; color:#16a34a; font-weight:bold;"; }

            tbodyHTML += `<td style="${diffStyle}">${diffStr}</td>
                          <td style="font-size:12px;">${row['ê³„ì•½ì¢…ë£Œì¼'] || ''}</td>
                          </tr>`;
        });

        tableBody.innerHTML = tbodyHTML;
        document.getElementById('resultArea').classList.remove('hidden');
        document.getElementById('count').innerText = data.length;
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ ì‹¤í–‰
    // window.onload = loadData; 
    // -> ìë™ ì‹¤í–‰ í•˜ë ¤ë©´ ì£¼ì„ í•´ì œ. í•˜ì§€ë§Œ ì²˜ìŒì—” data í´ë”ê°€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ìê°€ ë²„íŠ¼ ëˆ„ë¥´ê²Œ ìœ ë„í•˜ê±°ë‚˜, ê¸°ë³¸ê°’ ë¡œë“œ ì‹œë„.
    loadData(); // ì¼ë‹¨ ì‹œë„
</script>

</body>
</html>
